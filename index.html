<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="utf-8">
    <meta content="width=device-width, initial-scale=1.0" name="viewport">
    <title>Ficha D&D 5e - Mestre do Arsenal (Integrated)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&amp;family=Inter:wght@300;400;600;700&amp;family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,1,0" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        rpg: {
                            dark: '#050505',
                            panel: '#121212',
                            accent: '#00f2ff',     
                            text: '#e0e0e0',
                            muted: '#5e7274',
                            red: '#ff2a2a',
                            gold: '#ffd700',
                            combat: '#ff4d4d',     
                            utility: '#00ff9d',    
                            magic: '#d580ff',
                            alchemy: '#00e5ff',
                            tech: '#ff9100',
                            social: '#2979ff',
                        }
                    },
                    fontFamily: {
                        header: ['Cinzel', 'serif'],
                        body: ['Inter', 'sans-serif'],
                    },
                    boxShadow: {
                        'hud': '0 0 15px rgba(0, 242, 255, 0.1)',
                        'magic': '0 0 20px rgba(213, 128, 255, 0.15)',
                        'neon': '0 0 5px theme("colors.rpg.accent"), 0 0 10px theme("colors.rpg.accent")'
                    }
                }
            }
        }
    </script>
    <style>
        body { 
            background-color: #050505; 
            background-image: 
                radial-gradient(circle at 50% 0%, #1a1f2e 0%, #050505 80%),
                linear-gradient(rgba(255, 255, 255, 0.03) 1px, transparent 1px),
                linear-gradient(90deg, rgba(255, 255, 255, 0.03) 1px, transparent 1px);
            background-size: 100% 100%, 30px 30px, 30px 30px;
            color: #e0e0e0;
        }
        
        /* Scrollbar Moderna */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: #0a0a0a; }
        ::-webkit-scrollbar-thumb { background: #333; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #00f2ff; }
        
        /* Inputs Invis√≠veis mas Foc√°veis */
        input, select, textarea { transition: all 0.2s; background: transparent; }
        input:focus, select:focus, textarea:focus { outline: none; border-bottom-color: #00f2ff; background: rgba(0, 242, 255, 0.05); }
        input[type=number]::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }

        /* Pain√©is de Vidro */
        .glass-panel {
            background: rgba(18, 18, 18, 0.7);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.08);
            box-shadow: 0 4px 30px rgba(0, 0, 0, 0.5);
        }

        /* Abas Estilizadas */
        .nav-tabs { display: flex; gap: 1rem; overflow-x: auto; padding-bottom: 2px; scrollbar-width: none; }
        .nav-tabs::-webkit-scrollbar { display: none; }
        .tab-btn {
            background: rgba(255,255,255,0.03);
            border: 1px solid rgba(255,255,255,0.1);
            color: #888;
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            font-weight: 600;
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex;
            align-items: center;
            gap: 0.5rem;
            white-space: nowrap;
        }
        .tab-btn:hover { background: rgba(255,255,255,0.08); color: #fff; transform: translateY(-2px); }
        .tab-btn.active {
            background: rgba(0, 242, 255, 0.1);
            border-color: #00f2ff;
            color: #00f2ff;
            box-shadow: 0 0 15px rgba(0, 242, 255, 0.2);
        }
        .tab-content { display: none; animation: slideUpFade 0.4s ease-out; }
        .tab-content.active { display: block; } 

        @keyframes slideUpFade {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Highlight de Sugest√£o (Recuperado) */
        .suggestion-ring { 
            box-shadow: 0 0 0 1px #facc15, 0 0 10px rgba(250, 204, 21, 0.5); 
            animation: pulse-yellow 2s infinite; 
            background: rgba(250, 204, 21, 0.1) !important;
        }
        @keyframes pulse-yellow { 
            0% { box-shadow: 0 0 0 0px rgba(250, 204, 21, 0.7); } 
            70% { box-shadow: 0 0 0 2px rgba(250, 204, 21, 0); } 
            100% { box-shadow: 0 0 0 0px rgba(250, 204, 21, 0); } 
        }

        /* Equipamento Slots */
        .equip-slot-container { position: absolute; display: flex; align-items: center; transition: all 0.3s; z-index: 10; }
        .equip-input {
            background: rgba(0, 0, 0, 0.8);
            border: 1px solid #333;
            color: #ccc;
            font-size: 0.7rem;
            padding: 4px 8px;
            border-radius: 4px;
            width: 120px;
            text-align: center;
            backdrop-filter: blur(4px);
            cursor: pointer;
            transition: all 0.3s;
        }
        .equip-input:hover { border-color: #00f2ff; color: #fff; width: 130px; box-shadow: 0 0 10px rgba(0,242,255,0.2); }
        .equip-input.has-stats { border-color: #ffd700; color: #ffd700; }
        .slot-label { position: absolute; top: -14px; left: 50%; transform: translateX(-50%); font-size: 0.55rem; color: #555; text-transform: uppercase; font-weight: bold; pointer-events: none; white-space: nowrap; }
        
        /* Toggle Armar Magia (Recuperado) */
        .combat-toggle { width: 16px; height: 16px; border: 1px solid #444; border-radius: 4px; cursor: pointer; transition: all 0.2s; display: flex; align-items: center; justify-content: center; }
        .combat-toggle:hover { border-color: #fff; }
        .combat-toggle.active { background: #ff4d4d; border-color: #ff4d4d; box-shadow: 0 0 8px #ff4d4d; }
        .combat-toggle.active::after { content: '‚öîÔ∏è'; font-size: 10px; }

        /* Modal Overlay */
        .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.85); backdrop-filter: blur(8px); z-index: 100; display: none; align-items: center; justify-content: center; }
        .modal-overlay.open { display: flex; animation: fadeIn 0.2s; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* Badge Tags */
        .tag-badge { font-size: 0.6rem; padding: 2px 6px; border-radius: 4px; text-transform: uppercase; font-weight: bold; margin-right: 4px; display: inline-flex; align-items: center; gap: 2px; }
        .tag-equipped { background: rgba(0, 242, 255, 0.15); color: #00f2ff; border: 1px solid rgba(0, 242, 255, 0.3); }
        .tag-attuned { background: rgba(213, 128, 255, 0.15); color: #d580ff; border: 1px solid rgba(213, 128, 255, 0.3); }
        
        /* Loading Spinner */
        .loader { border: 2px solid #333; border-top: 2px solid #d580ff; border-radius: 50%; width: 16px; height: 16px; animation: spin 1s linear infinite; display: inline-block; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* Colaps√°veis */
        .collapsible-content { transition: max-height 0.4s ease-out, opacity 0.4s ease-out; max-height: 0; overflow: hidden; opacity: 0; }
        .collapsible-content.open { max-height: 2000px; opacity: 1; }
        .rotate-chevron { transition: transform 0.3s; }
        .rotate-chevron.open { transform: rotate(180deg); }
    </style>
</head>
<body class="font-body text-gray-300 p-2 md:p-6 pb-32">

    <!-- MENU FLUTUANTE -->
    <div class="fixed bottom-6 right-6 z-50 flex flex-col gap-3">
        <button onclick="downloadSheet()" class="bg-rpg-accent text-black font-bold p-4 rounded-full shadow-[0_0_20px_rgba(0,242,255,0.4)] hover:bg-white hover:scale-110 transition-all flex items-center justify-center group" title="Salvar Ficha">
            <span class="material-symbols-outlined text-2xl group-hover:rotate-12 transition-transform">save</span>
        </button>
    </div>

    <!-- MODAL EDITOR DE ITEM -->
    <div id="item-editor-modal" class="modal-overlay">
        <div class="bg-[#121212] border border-rpg-accent rounded-2xl w-[95%] max-w-lg p-6 shadow-2xl relative overflow-hidden">
            <div class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-transparent via-rpg-accent to-transparent"></div>
            <h3 class="font-header text-2xl text-white mb-6 flex items-center gap-3">
                <span class="bg-rpg-accent/10 p-2 rounded-lg text-rpg-accent"><span class="material-symbols-outlined">edit_square</span></span>
                Editar Equipamento
            </h3>
            <input type="hidden" id="modal-target-id"> <input type="hidden" id="modal-context-type"> 
            
            <div class="space-y-5">
                <div class="bg-black/40 p-3 rounded-lg border border-dashed border-gray-700">
                    <label class="text-[10px] uppercase text-rpg-accent font-bold block mb-2 tracking-wider">üìö Biblioteca R√°pida</label>
                    <select id="item-library-select" class="w-full bg-[#1a1a1a] text-gray-300 p-2 rounded border border-gray-700 text-sm focus:border-rpg-accent" onchange="importItemFromLib(this)">
                        <option value="">-- Importar Item Padr√£o --</option>
                    </select>
                </div>

                <div class="flex gap-4">
                    <div class="flex-grow">
                        <label class="text-[10px] uppercase text-gray-500 font-bold mb-1 block">Nome do Item</label>
                        <input id="modal-item-name" class="w-full bg-black/50 text-white p-2 rounded border border-gray-700 focus:border-rpg-accent text-sm" placeholder="Ex: Espada Longa +1">
                    </div>
                    <div class="w-24">
                        <label class="text-[10px] uppercase text-gray-500 font-bold mb-1 block">Peso (kg)</label>
                        <input id="modal-item-weight" type="number" step="0.1" class="w-full bg-black/50 text-white p-2 rounded border border-gray-700 focus:border-rpg-accent text-sm text-center" placeholder="0.0">
                    </div>
                </div>
                <div>
                    <label class="text-[10px] uppercase text-gray-500 font-bold mb-1 block">Descri√ß√£o &amp; Propriedades</label>
                    <textarea id="modal-item-desc" class="w-full bg-black/50 text-gray-300 p-3 rounded border border-gray-700 focus:border-rpg-accent text-sm resize-none h-24 custom-scrollbar" placeholder="Descreva os efeitos m√°gicos ou mec√¢nicos..."></textarea>
                </div>
                
                <div id="modal-bonuses-section" class="bg-black/20 p-4 rounded-xl border border-gray-800">
                    <label class="text-[10px] uppercase text-rpg-gold font-bold mb-3 block flex items-center gap-2">
                        <span class="material-symbols-outlined text-sm">auto_awesome</span> B√¥nus Autom√°ticos (Quando Equipado)
                    </label>
                    <div class="grid grid-cols-4 gap-3">
                        <div class="text-center"><label class="text-[9px] text-gray-500 block mb-1">CA</label><input id="modal-bonus-ac" type="number" class="w-full bg-black/40 border border-gray-700 rounded text-rpg-accent font-bold text-center py-1 focus:border-rpg-gold" placeholder="0"></div>
                        <div class="text-center"><label class="text-[9px] text-gray-500 block mb-1">ATQ</label><input id="modal-bonus-atk" type="number" class="w-full bg-black/40 border border-gray-700 rounded text-rpg-accent font-bold text-center py-1 focus:border-rpg-gold" placeholder="0"></div>
                        <div class="text-center"><label class="text-[9px] text-gray-500 block mb-1">DANO</label><input id="modal-bonus-dmg" type="number" class="w-full bg-black/40 border border-gray-700 rounded text-rpg-accent font-bold text-center py-1 focus:border-rpg-gold" placeholder="0"></div>
                        <div class="text-center"><label class="text-[9px] text-gray-500 block mb-1">CD MAGIA</label><input id="modal-bonus-dc" type="number" class="w-full bg-black/40 border border-gray-700 rounded text-rpg-accent font-bold text-center py-1 focus:border-rpg-gold" placeholder="0"></div>
                    </div>
                </div>
            </div>

            <div class="flex justify-end gap-3 mt-8 pt-4 border-t border-gray-800">
                <button onclick="closeItemEditor()" class="px-5 py-2 rounded text-gray-400 hover:text-white transition-colors text-sm font-bold">Cancelar</button>
                <button onclick="saveItemEditor()" class="px-6 py-2 rounded bg-rpg-accent text-black font-bold hover:bg-white shadow-[0_0_15px_rgba(0,242,255,0.3)] transition-all transform hover:-translate-y-0.5 text-sm">Salvar Altera√ß√µes</button>
            </div>
        </div>
    </div>

    <!-- MODAL DE SELE√á√ÉO DE MAGIA (COM API) -->
    <div id="spell-selector-modal" class="modal-overlay">
        <div class="bg-[#121212] border border-rpg-magic rounded-2xl w-[95%] max-w-lg p-6 shadow-2xl relative">
            <h3 class="font-header text-2xl text-rpg-magic mb-4 flex items-center gap-3">
                <span class="bg-rpg-magic/10 p-2 rounded-lg"><span class="material-symbols-outlined">auto_stories</span></span>
                Novo Feiti√ßo
            </h3>
            <input type="hidden" id="modal-spell-level"> 
            
            <div class="space-y-4">
                <!-- Se√ß√£o API -->
                <div class="bg-rpg-magic/5 p-3 rounded-lg border border-rpg-magic/20">
                    <label class="text-[10px] uppercase text-rpg-magic font-bold block mb-2 flex justify-between">
                        <span>üåê Pesquisar na API (Online)</span>
                        <span class="text-xs text-gray-500 normal-case">D&D 5e API (Ingl√™s)</span>
                    </label>
                    <div class="flex gap-2">
                        <input id="api-spell-search" class="w-full bg-black/50 text-white p-2 rounded border border-gray-600 text-sm focus:border-rpg-magic" placeholder="Ex: Fireball, Cure Wounds..." onkeypress="if(event.key==='Enter') searchSpellApi()">
                        <button onclick="searchSpellApi()" class="bg-rpg-magic text-black font-bold px-3 rounded hover:bg-white transition-colors"><span class="material-symbols-outlined text-sm">search</span></button>
                    </div>
                    <div id="api-search-results" class="mt-2 max-h-32 overflow-y-auto custom-scrollbar hidden space-y-1"></div>
                </div>

                <div class="relative flex py-2 items-center">
                    <div class="flex-grow border-t border-gray-800"></div>
                    <span class="flex-shrink mx-4 text-gray-600 text-xs">OU</span>
                    <div class="flex-grow border-t border-gray-800"></div>
                </div>

                <!-- Se√ß√£o Interna -->
                <div class="bg-black/30 p-3 rounded-lg border border-dashed border-gray-700">
                    <label class="text-[10px] uppercase text-rpg-muted font-bold block mb-2">Biblioteca Interna (PT-BR) <span id="spell-class-filter-display" class="text-white ml-1 opacity-50 font-normal"></span></label>
                    <select id="spell-library-select" class="w-full bg-[#1a1a1a] text-white p-2 rounded border border-gray-600 text-sm focus:border-rpg-magic focus:ring-1 focus:ring-rpg-magic">
                        <option value="">-- Selecione da Lista --</option>
                    </select>
                </div>
                
                <div class="grid grid-cols-2 gap-4 pt-2">
                    <button onclick="addSelectedSpellFromLib()" class="bg-rpg-magic/20 border border-rpg-magic text-rpg-magic font-bold py-2 rounded hover:bg-rpg-magic hover:text-black transition-colors flex items-center justify-center gap-2">
                        Adicionar (PT-BR)
                    </button>
                    <button onclick="addCustomSpell()" class="bg-transparent border border-gray-600 text-gray-400 font-bold py-2 rounded hover:border-white hover:text-white transition-colors flex items-center justify-center gap-2">
                        Criar Vazio
                    </button>
                </div>
            </div>
            <div class="flex justify-center mt-4">
                <button onclick="closeSpellModal()" class="text-gray-500 hover:text-white text-sm underline">Fechar</button>
            </div>
        </div>
    </div>

    <!-- CABE√áALHO -->
    <header class="max-w-7xl mx-auto mb-8 pt-4 flex flex-col md:flex-row gap-6 md:items-center border-b border-gray-800 pb-6 animate-up">
        <div class="flex items-center gap-6 flex-grow">
            <div class="relative group w-24 h-24 rounded-2xl border-2 border-rpg-accent overflow-hidden shadow-hud bg-black cursor-pointer shrink-0">
                <img class="w-full h-full object-cover opacity-80 group-hover:opacity-100 transition-opacity" id="char-portrait" src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='100' height='100' viewBox='0 0 100 100'%3E%3Crect width='100' height='100' fill='%23111'/%3E%3Cpath d='M50 30a15 15 0 1 1 0 30 15 15 0 0 1 0-30zm0 35c15 0 30 10 30 25v10H20V90c0-15 15-25 30-25z' fill='%23333'/%3E%3C/svg%3E">
                <div class="absolute inset-0 flex items-center justify-center bg-black/50 opacity-0 group-hover:opacity-100 transition-opacity">
                    <span class="material-symbols-outlined text-white text-2xl">add_a_photo</span>
                </div>
                <input accept="image/*" class="absolute inset-0 opacity-0 cursor-pointer" onchange="loadPortrait(event)" type="file">
            </div>
            
            <div class="flex-grow space-y-3">
                <input class="w-full bg-transparent text-3xl md:text-4xl text-white font-header border-none p-0 focus:ring-0 placeholder-gray-700" placeholder="Nome do Her√≥i" value="">
                <div class="flex gap-4 text-sm text-gray-400">
                    <div class="flex items-center gap-2 bg-white/5 px-3 py-1 rounded">
                        <select id="char-class-select" onchange="updateClassFeatures()" class="bg-transparent outline-none cursor-pointer text-rpg-accent font-bold hover:text-white"><option value="">Classe</option></select>
                        <select id="char-subclass-select" onchange="updateSubclassFeatures()" class="bg-transparent outline-none cursor-pointer text-rpg-gold font-bold hover:text-white hidden"><option value="">Esp.</option></select>
                    </div>
                    <div class="flex items-center gap-2 bg-white/5 px-3 py-1 rounded">
                        <select id="char-race-select" onchange="updateRaceFeatures()" class="bg-transparent outline-none cursor-pointer text-rpg-accent font-bold hover:text-white"><option value="">Ra√ßa</option></select>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="flex items-center gap-4 bg-rpg-panel border border-gray-800 p-3 rounded-xl shadow-lg">
            <div class="text-center px-2">
                <span class="block text-[10px] text-gray-500 uppercase font-bold tracking-widest">N√≠vel</span>
                <input class="w-12 bg-transparent text-3xl font-bold text-white text-center outline-none border-none p-0" id="char-level" max="20" min="1" type="number" value="1" onchange="updateClassFeatures()">
            </div>
            <div class="h-10 w-[1px] bg-gray-700"></div>
            <div class="text-center px-2">
                <span class="block text-[10px] text-gray-500 uppercase font-bold tracking-widest">Prof.</span>
                <span class="block text-3xl font-bold text-rpg-muted" id="prof-bonus">+2</span>
            </div>
        </div>
    </header>

    <!-- NAVEGA√á√ÉO POR ABAS -->
    <nav class="max-w-7xl mx-auto mb-8 nav-tabs sticky top-0 z-40 bg-[#050505]/90 backdrop-blur py-2">
        <button onclick="switchTab('status')" id="btn-status" class="tab-btn active"><span class="material-symbols-outlined text-lg">person</span> Geral</button>
        <button onclick="switchTab('combat')" id="btn-combat" class="tab-btn"><span class="material-symbols-outlined text-lg">swords</span> Combate</button>
        <button onclick="switchTab('spells')" id="btn-spells" class="tab-btn"><span class="material-symbols-outlined text-lg">auto_stories</span> Grim√≥rio</button>
        <button onclick="switchTab('equip')" id="btn-equip" class="tab-btn"><span class="material-symbols-outlined text-lg">backpack</span> Invent√°rio</button>
        <button onclick="switchTab('passives')" id="btn-passives" class="tab-btn"><span class="material-symbols-outlined text-lg">stars</span> Talentos</button>
    </nav>

    <main class="max-w-7xl mx-auto min-h-[600px] relative">
        
        <!-- ABA 1: STATUS -->
        <section id="tab-status" class="tab-content active">
            <div class="grid grid-cols-1 lg:grid-cols-12 gap-8">
                <div class="lg:col-span-3 space-y-3" id="attributes-container"></div>
                <div class="lg:col-span-9 flex flex-col gap-6">
                    <div class="grid grid-cols-2 md:grid-cols-3 gap-4">
                        <div class="glass-panel p-4 rounded-xl flex flex-col items-center justify-center relative group overflow-hidden">
                            <div class="absolute inset-0 bg-rpg-accent/5 group-hover:bg-rpg-accent/10 transition-colors"></div>
                            <span class="text-[10px] text-rpg-accent uppercase tracking-widest font-bold mb-1 relative z-10">Classe de Armadura</span>
                            <div class="flex items-end gap-1 relative z-10">
                                <span class="text-xs text-gray-500 mb-1">10 +</span>
                                <input class="w-10 bg-transparent text-3xl font-bold text-white text-center outline-none border-b border-gray-700 focus:border-rpg-accent" id="ac-bonus-manual" type="number" value="0">
                                <span class="text-xs text-rpg-gold ml-1 hidden animate-pulse" id="ac-equip-bonus-display" title="B√¥nus de Equipamento">+0</span>
                            </div>
                            <span class="text-xs text-gray-400 mt-1 relative z-10">Total: <span id="ac-total-display" class="text-white font-bold text-lg">10</span></span>
                        </div>
                        <div class="glass-panel p-4 rounded-xl flex flex-col items-center justify-center">
                            <span class="text-[10px] text-rpg-accent uppercase tracking-widest font-bold mb-1">Iniciativa</span>
                            <span class="block text-4xl font-bold text-rpg-gold drop-shadow-md" id="initiative-display">+0</span>
                            <span class="text-[9px] text-gray-500 mt-1">Destreza</span>
                        </div>
                        <div class="glass-panel p-4 rounded-xl flex flex-col items-center justify-center">
                            <span class="text-[10px] text-rpg-accent uppercase tracking-widest font-bold mb-1">Deslocamento</span>
                            <input class="w-full bg-transparent text-4xl font-bold text-white text-center outline-none" id="char-speed" type="text" value="9m">
                        </div>
                    </div>
                    <div class="glass-panel rounded-xl p-5 relative overflow-hidden flex flex-col md:flex-row items-center justify-between group border-l-4 border-l-rpg-red">
                        <div class="flex items-center gap-4 z-10 w-full md:w-auto mb-4 md:mb-0">
                            <div class="w-12 h-12 rounded-full bg-rpg-red/20 flex items-center justify-center text-rpg-red border border-rpg-red/50 shadow-[0_0_10px_rgba(255,42,42,0.3)]"><span class="material-symbols-outlined text-2xl">favorite</span></div>
                            <div><span class="font-header text-xl text-white block leading-none">Pontos de Vida</span><span class="text-[10px] text-gray-500 uppercase tracking-wider">Vitalidade &amp; Sa√∫de</span></div>
                        </div>
                        <div class="flex gap-8 z-10">
                            <div class="text-center"><input class="bg-black/30 text-3xl font-bold text-white text-center w-24 rounded-lg border border-gray-700 focus:border-rpg-red outline-none py-1" placeholder="--" type="number" value=""><span class="text-[9px] uppercase text-gray-500 block mt-1 font-bold">Atuais</span></div>
                            <div class="text-center relative"><span class="absolute -left-4 top-1/2 -translate-y-1/2 text-gray-600 text-xl">/</span><input class="bg-black/30 text-3xl font-bold text-gray-400 text-center w-24 rounded-lg border border-gray-700 focus:border-white outline-none py-1" placeholder="--" type="number" value=""><span class="text-[9px] uppercase text-gray-500 block mt-1 font-bold">M√°ximo</span></div>
                        </div>
                    </div>
                    <div class="glass-panel rounded-xl p-6 shadow-lg">
                        <div class="flex justify-between items-center mb-4 pb-2 border-b border-gray-800"><h3 class="font-header text-lg text-white flex items-center gap-2"><span class="material-symbols-outlined text-rpg-accent">psychology</span> Per√≠cias</h3><span id="skill-hint" class="text-[10px] bg-yellow-500/10 text-yellow-500 border border-yellow-500/30 px-2 py-1 rounded hidden animate-pulse">Recomendado para Classe</span></div>
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-x-8 gap-y-1" id="skills-list"></div>
                    </div>
                </div>
            </div>
        </section>

        <!-- ABA 2: COMBATE -->
        <section id="tab-combat" class="tab-content hidden">
            <div class="glass-panel rounded-xl p-6 shadow-2xl border-t-4 border-t-rpg-combat relative overflow-hidden">
                <div class="absolute top-0 right-0 p-3 opacity-10"><span class="material-symbols-outlined text-9xl">swords</span></div>
                <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 relative z-10">
                    <div><h2 class="font-header text-3xl text-white flex items-center gap-3">Combate</h2><p class="text-xs text-gray-500 mt-1 uppercase tracking-wide">Ataques, Armas &amp; Magias Ofensivas</p></div>
                    <div class="flex items-center gap-3 bg-black/40 p-2 rounded-lg border border-gray-700 mt-4 md:mt-0"><span class="material-symbols-outlined text-gray-500 text-sm">filter_vintage</span><div class="flex items-center gap-2 text-sm"><input class="w-12 bg-transparent text-center text-white font-bold border-b border-gray-600 focus:border-rpg-combat outline-none" placeholder="0" type="number"><span class="text-gray-700">|</span><input class="w-12 bg-transparent text-center text-white font-bold border-b border-gray-600 focus:border-rpg-combat outline-none" placeholder="0" type="number"></div></div>
                </div>
                <div id="global-combat-bonuses" class="hidden mb-6 p-3 bg-rpg-combat/10 border border-rpg-combat/30 rounded-lg flex items-center gap-4 animate-up"><span class="bg-rpg-combat text-black text-[10px] font-bold px-2 py-1 rounded uppercase">Equipamento Ativo</span><span class="text-xs text-gray-300" id="global-atk-display">+0 Ataque</span><span class="text-xs text-gray-300" id="global-dmg-display">+0 Dano</span></div>
                <div class="overflow-x-auto custom-scrollbar pb-4">
                    <table class="w-full text-left border-collapse min-w-[900px]">
                        <thead class="text-[10px] uppercase text-gray-500 bg-black/30 tracking-wider"><tr><th class="p-3 w-8 rounded-l-lg"></th><th class="p-3 text-center w-12">√çcone</th><th class="p-3 text-center w-10">Prof</th><th class="p-3 w-48">Nome</th><th class="p-3 w-20">Attr</th><th class="p-3 w-16 text-center text-rpg-magic">M√°gico</th><th class="p-3 text-center w-24 text-rpg-accent">Acerto</th><th class="p-3 w-24">Dano Base</th><th class="p-3 text-left w-32 text-rpg-combat">Dano Total</th><th class="p-3 w-24">Tipo</th><th class="p-3 w-10 rounded-r-lg"></th></tr></thead>
                        <tbody class="text-sm divide-y divide-gray-800" id="combat-rows"></tbody>
                        <tbody class="text-sm divide-y divide-gray-800 bg-rpg-magic/5" id="spell-combat-rows"></tbody>
                    </table>
                </div>
                <button class="w-full py-3 mt-4 border border-dashed border-gray-700 text-gray-500 hover:text-rpg-combat hover:border-rpg-combat hover:bg-rpg-combat/5 transition-colors rounded-lg uppercase font-bold text-xs tracking-wider flex items-center justify-center gap-2" onclick="addCombatRow()"><span class="material-symbols-outlined text-sm">add</span> Adicionar Arma Manual</button>
            </div>
        </section>

        <!-- ABA 3: GRIM√ìRIO -->
        <section id="tab-spells" class="tab-content hidden">
            <div class="glass-panel border-t-4 border-t-rpg-magic rounded-xl p-6 shadow-magic mb-8">
                <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-6">
                    <div><h2 class="font-header text-3xl text-white flex items-center gap-3">Grim√≥rio Arcano</h2><div class="flex items-center gap-4 mt-2"><div class="flex flex-col"><label class="text-[9px] text-rpg-magic uppercase font-bold mb-1">Atributo</label><select class="bg-black/40 text-white font-bold border border-gray-700 rounded px-2 py-1 text-sm outline-none focus:border-rpg-magic" id="spellcasting-ability" onchange="calculateAll()"><option value="int">Intelig√™ncia</option><option value="wis">Sabedoria</option><option value="cha">Carisma</option></select></div></div></div>
                    <div class="flex gap-4"><div class="bg-black/40 p-3 rounded-lg border border-gray-700 text-center min-w-[80px]"><span class="block text-2xl font-bold text-white" id="spell-save-dc">10</span><span class="text-[9px] text-rpg-magic uppercase font-bold">CD Res</span></div><div class="bg-black/40 p-3 rounded-lg border border-gray-700 text-center min-w-[80px]"><span class="block text-2xl font-bold text-rpg-accent" id="spell-attack-bonus">+2</span><span class="text-[9px] text-rpg-accent uppercase font-bold">B√¥nus Atq</span></div></div>
                </div>
            </div>
            <div class="space-y-6" id="spell-levels-container"></div>
        </section>

        <!-- ABA 4: INVENT√ÅRIO -->
        <section id="tab-equip" class="tab-content hidden">
            <div class="grid grid-cols-1 xl:grid-cols-[1fr_500px] gap-8">
                <div class="glass-panel rounded-xl flex flex-col h-[800px] shadow-lg border border-gray-800">
                    <div class="p-5 border-b border-gray-800 flex justify-between items-center bg-black/20"><h3 class="font-header text-xl text-white flex items-center gap-2"><span class="material-symbols-outlined text-rpg-muted">backpack</span> Mochila</h3><div class="text-right"><span class="block text-[9px] text-gray-500 uppercase font-bold">Peso Total</span><span class="font-bold text-sm text-gray-300" id="weight-display">0.0 / <span id="max-weight">75</span> kg</span></div></div>
                    <div class="flex-grow overflow-y-auto custom-scrollbar p-2">
                        <table class="w-full text-left text-sm border-collapse"><thead class="text-[9px] uppercase text-gray-500 font-bold sticky top-0 bg-[#121212] z-10 shadow-sm"><tr><th class="py-2 pl-3 w-10"></th><th class="py-2 pl-2">Item</th><th class="py-2 text-center w-14">Qtd</th><th class="py-2 text-right w-16 pr-3">Kg</th><th class="py-2 w-8"></th></tr></thead><tbody id="inventory-equipped-rows" class="bg-rpg-accent/5"></tbody><tbody id="inventory-rows" class="divide-y divide-gray-800/50"></tbody></table>
                        <button class="w-full py-3 mt-4 border border-dashed border-gray-800 text-gray-600 hover:text-white hover:border-gray-600 rounded transition-colors text-xs font-bold uppercase" onclick="addInventoryRow()">+ Adicionar Item Manual</button>
                    </div>
                    <div class="p-4 border-t border-gray-800 bg-black/20 grid grid-cols-5 gap-2">
                        <div class="bg-black/40 p-2 rounded border border-gray-700 text-center"><label class="block text-[8px] text-[#bcaaa4] mb-1 font-bold">PC</label><input class="w-full bg-transparent text-center text-white font-bold outline-none" type="number" value="0"></div>
                        <div class="bg-black/40 p-2 rounded border border-gray-700 text-center"><label class="block text-[8px] text-[#cfd8dc] mb-1 font-bold">PRATA</label><input class="w-full bg-transparent text-center text-white font-bold outline-none" type="number" value="0"></div>
                        <div class="bg-black/40 p-2 rounded border border-gray-700 text-center"><label class="block text-[8px] text-[#ffd54f] mb-1 font-bold">ELECTRUM</label><input class="w-full bg-transparent text-center text-white font-bold outline-none" type="number" value="0"></div>
                        <div class="bg-black/40 p-2 rounded border border-gray-700 text-center"><label class="block text-[8px] text-[#ffb74d] mb-1 font-bold">OURO</label><input class="w-full bg-transparent text-center text-white font-bold outline-none" type="number" value="0"></div>
                        <div class="bg-black/40 p-2 rounded border border-gray-700 text-center"><label class="block text-[8px] text-[#e1bee7] mb-1 font-bold">PLATINA</label><input class="w-full bg-transparent text-center text-white font-bold outline-none" type="number" value="0"></div>
                    </div>
                </div>
                <div class="glass-panel rounded-xl p-4 flex flex-col items-center relative h-[800px] overflow-y-auto custom-scrollbar">
                    <h3 class="font-header text-lg text-rpg-accent mb-4 absolute top-4 left-4 z-20">Equipamento</h3>
                    <div class="relative w-full h-[950px] mt-10 select-none scale-90 origin-top">
                        <div class="absolute left-1/2 top-0 transform -translate-x-1/2 w-[400px] h-full opacity-20 pointer-events-none"><svg viewBox="0 0 200 500" class="h-full w-auto text-white fill-current"><path d="M100 20 C120 20 135 35 135 55 C135 75 120 90 100 90 C80 90 65 75 65 55 C65 35 80 20 100 20 Z M40 110 L160 110 L150 250 L100 250 L50 250 L40 110 Z M50 260 L95 260 L90 450 L60 450 L50 260 Z M105 260 L150 260 L140 450 L110 450 L105 260 Z" /></svg></div>
                        <div class="equip-slot-container flex-col" style="top: 0%; left: 50%; transform: translateX(-50%);"><span class="slot-label">Cabe√ßa</span><div class="attunement-indicator" onclick="toggleAttune(this)"></div><input class="equip-input" data-slot="head" placeholder="Vazio" readonly onclick="openItemEditor(this)"></div>
                        <div class="equip-slot-container flex-row-reverse" style="top: 6%; left: 10%;"><input class="equip-input" data-slot="face" placeholder="Vazio" readonly onclick="openItemEditor(this)"><div class="attunement-indicator" onclick="toggleAttune(this)"></div><span class="slot-label" style="left:50%">Rosto</span></div>
                        <div class="equip-slot-container flex-row" style="top: 6%; right: 10%;"><div class="attunement-indicator" onclick="toggleAttune(this)"></div><input class="equip-input" data-slot="ears" placeholder="Vazio" readonly onclick="openItemEditor(this)"><span class="slot-label" style="left:50%">Orelhas</span></div>
                        <div class="equip-slot-container flex-col" style="top: 14%; left: 50%; transform: translateX(-50%); z-index:15;"><div class="attunement-indicator" onclick="toggleAttune(this)"></div><input class="equip-input" data-slot="neck" placeholder="Vazio" readonly onclick="openItemEditor(this)"></div>
                        <div class="equip-slot-container flex-row-reverse" style="top: 18%; left: 5%;"><input class="equip-input" data-slot="back" placeholder="Vazio" readonly onclick="openItemEditor(this)"><div class="attunement-indicator" onclick="toggleAttune(this)"></div><span class="slot-label" style="left:50%">Costas</span></div>
                        <div class="equip-slot-container flex-row" style="top: 25%; right: 5%;"><div class="attunement-indicator" onclick="toggleAttune(this)"></div><input class="equip-input" data-slot="body_skin" placeholder="Vazio" readonly onclick="openItemEditor(this)"><span class="slot-label" style="left:50%">Corpo</span></div>
                        <div class="equip-slot-container flex-col" style="top: 28%; left: 50%; transform: translateX(-50%); z-index:20;"><span class="slot-label text-rpg-gold font-bold">Torso (Armadura)</span><div class="attunement-indicator" onclick="toggleAttune(this)"></div><input class="equip-input border-rpg-gold/50 text-rpg-accent font-bold" data-slot="torso" placeholder="Armadura" readonly onclick="openItemEditor(this)"></div>
                        <div class="equip-slot-container flex-row-reverse" style="top: 38%; left: 2%;"><input class="equip-input" data-slot="wrist_l" placeholder="Vazio" readonly onclick="openItemEditor(this)"><div class="attunement-indicator" onclick="toggleAttune(this)"></div><span class="slot-label" style="left:50%">Pulso</span></div>
                        <div class="equip-slot-container flex-row" style="top: 38%; right: 2%;"><div class="attunement-indicator" onclick="toggleAttune(this)"></div><input class="equip-input" data-slot="wrist_r" placeholder="Vazio" readonly onclick="openItemEditor(this)"><span class="slot-label" style="left:50%">Pulso</span></div>
                        <div class="equip-slot-container flex-col" style="top: 40%; left: 50%; transform: translateX(-50%);"><input class="equip-input" data-slot="hands" placeholder="Vazio" readonly onclick="openItemEditor(this)"><span class="slot-label" style="top: 35px">M√£os</span></div>
                        <div class="equip-slot-container flex-col" style="top: 48%; left: 50%; transform: translateX(-50%);"><span class="slot-label">Cintura</span><div class="attunement-indicator" onclick="toggleAttune(this)"></div><input class="equip-input" data-slot="waist" placeholder="Cinto" readonly onclick="openItemEditor(this)"></div>
                        <div class="equip-slot-container flex-row-reverse" style="top: 55%; left: 0%;"><input class="equip-input h-10 border-rpg-accent font-bold" data-slot="hand_l" placeholder="M√£o Esquerda" readonly onclick="openItemEditor(this)"><div class="attunement-indicator" onclick="toggleAttune(this)"></div><span class="slot-label text-rpg-accent font-bold" style="left:50%">M√£o Esq.</span></div>
                        <div class="equip-slot-container flex-row" style="top: 55%; right: 0%;"><div class="attunement-indicator" onclick="toggleAttune(this)"></div><input class="equip-input h-10 border-rpg-accent font-bold" data-slot="hand_r" placeholder="M√£o Direita" readonly onclick="openItemEditor(this)"><span class="slot-label text-rpg-accent font-bold" style="left:50%">M√£o Dir.</span></div>
                        <div class="equip-slot-container flex-row-reverse" style="top: 65%; left: 8%;"><input class="equip-input" data-slot="finger_l" placeholder="Vazio" readonly onclick="openItemEditor(this)"><div class="attunement-indicator" onclick="toggleAttune(this)"></div></div>
                        <div class="equip-slot-container flex-row" style="top: 65%; right: 8%;"><div class="attunement-indicator" onclick="toggleAttune(this)"></div><input class="equip-input" data-slot="finger_r" placeholder="Vazio" readonly onclick="openItemEditor(this)"></div>
                        <div class="equip-slot-container flex-col" style="top: 90%; left: 50%; transform: translateX(-50%);"><span class="slot-label">P√©s</span><div class="attunement-indicator" onclick="toggleAttune(this)"></div><input class="equip-input" data-slot="feet" placeholder="Vazio" readonly onclick="openItemEditor(this)"></div>
                    </div>
                </div>
            </div>
        </section>

        <!-- ABA 5: PASSIVAS -->
        <section id="tab-passives" class="tab-content hidden">
            <div class="flex justify-between items-center mb-6">
                <h2 class="font-header text-2xl text-white">Talentos &amp; Caracter√≠sticas</h2>
                <button class="bg-white/10 hover:bg-white/20 text-white px-4 py-2 rounded-lg font-bold text-xs uppercase tracking-widest transition-colors flex items-center gap-2" onclick="addPassive()">
                    <span class="material-symbols-outlined text-sm">add</span> Adicionar Novo
                </button>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6" id="passives-grid"></div>
        </section>

    </main>

<script>
    // --- FUN√á√ÉO DE ABAS CORRIGIDA ---
    function switchTab(tabId) {
        // Esconde todas usando a classe 'hidden'
        document.querySelectorAll('.tab-content').forEach(el => {
            el.classList.add('hidden');
        });
        document.querySelectorAll('.tab-btn').forEach(el => {
            el.classList.remove('active');
        });
        
        // Mostra a selecionada removendo 'hidden'
        const activeTab = document.getElementById('tab-' + tabId);
        if(activeTab) {
            activeTab.classList.remove('hidden');
        }
        
        const activeBtn = document.getElementById('btn-' + tabId);
        if(activeBtn) {
            activeBtn.classList.add('active');
        }
    }

    // --- L√ìGICA DO SISTEMA ---
    const attributes = [{id:'str',abbr:'FOR'},{id:'dex',abbr:'DES'},{id:'con',abbr:'CON'},{id:'int',abbr:'INT'},{id:'wis',abbr:'SAB'},{id:'cha',abbr:'CAR'}];
    const skills = [{name:'Acrobacia',attr:'dex'},{name:'Arcanismo',attr:'int'},{name:'Atletismo',attr:'str'},{name:'Atua√ß√£o',attr:'cha'},{name:'Engana√ß√£o',attr:'cha'},{name:'Furtividade',attr:'dex'},{name:'Hist√≥ria',attr:'int'},{name:'Intimida√ß√£o',attr:'cha'},{name:'Intui√ß√£o',attr:'wis'},{name:'Investiga√ß√£o',attr:'int'},{name:'Lidar com Animais',attr:'wis'},{name:'Medicina',attr:'wis'},{name:'Natureza',attr:'int'},{name:'Percep√ß√£o',attr:'wis'},{name:'Persuas√£o',attr:'cha'},{name:'Prestidigita√ß√£o',attr:'dex'},{name:'Religi√£o',attr:'int'},{name:'Sobreviv√™ncia',attr:'wis'}];
    const damageTypes = [{val:'fire',label:'Fogo',icon:'local_fire_department',color:'text-red-500'}, {val:'cold',label:'Frio',icon:'ac_unit',color:'text-cyan-400'}, {val:'lightning',label:'El√©trico',icon:'flash_on',color:'text-yellow-400'}, {val:'necrotic',label:'Necr√≥tico',icon:'skull',color:'text-green-600'}, {val:'radiant',label:'Radiante',icon:'sunny',color:'text-yellow-200'}, {val:'acid',label:'√Åcido',icon:'science',color:'text-green-500'}, {val:'poison',label:'Veneno',icon:'coronavirus',color:'text-green-700'}, {val:'psychic',label:'Ps√≠quico',icon:'psychology',color:'text-pink-500'}, {val:'force',label:'Energia',icon:'lens_blur',color:'text-purple-400'}, {val:'thunder',label:'Trov√£o',icon:'surround_sound',color:'text-blue-400'}, {val:'heal',label:'Cura',icon:'favorite',color:'text-red-400'}, {val:'slashing',label:'Cortante',icon:'content_cut',color:'text-gray-400'}, {val:'piercing',label:'Perfurante',icon:'gps_fixed',color:'text-gray-400'}, {val:'bludgeoning',label:'Contundente',icon:'hammer',color:'text-gray-400'}, {val:'utility',label:'Utilidade',icon:'auto_fix_high',color:'text-gray-400'}];
    const passiveTypes = [{id:'combat',label:'Combate',icon:'swords',color:'bg-rpg-combat',border:'border-rpg-combat', textColor:'text-rpg-combat'}, {id:'utility',label:'Utilidade',icon:'visibility',color:'bg-rpg-utility',border:'border-rpg-utility', textColor:'text-rpg-utility'}, {id:'magic',label:'Magia',icon:'auto_fix_high',color:'bg-rpg-magic',border:'border-rpg-magic', textColor:'text-rpg-magic'}, {id:'alchemy',label:'Alquimia',icon:'science',color:'bg-rpg-alchemy',border:'border-rpg-alchemy', textColor:'text-rpg-alchemy'}, {id:'tech',label:'Tecnologia',icon:'precision_manufacturing',color:'bg-rpg-tech',border:'border-rpg-tech', textColor:'text-rpg-tech'}, {id:'social',label:'Social',icon:'groups',color:'bg-rpg-social',border:'border-rpg-social', textColor:'text-rpg-social'}];
    let defaultSlots = [4, 4, 4, 4, 3, 3, 3, 2, 2];
    let equipmentData = {};
    let inventoryData = {}; 

    // Incluir SRD_LIB (Recuperada com dados completos)
    const SRD_LIB = {
        classes: {
            "B√°rbaro": { hitDie: 12, skills: ['str', 'con'], skillOpts: [2, 11, 12, 13, 17], saves: ['str', 'con'], slots: null, subclassLevel: 3, features: [{name: "F√∫ria", desc: "Vantagem em testes de For√ßa e Resist√™ncia de For√ßa. Dano extra com For√ßa. Resist√™ncia a concuss√£o, cortante e perfurante. (2/descanso)"}, {name: "Defesa sem Armadura", desc: "CA = 10 + Des + Con (enquanto sem armadura)."}, {name: "Ataque Descuidado", desc: "Pode atacar com vantagem, mas inimigos tem vantagem contra voc√™."}] },
            "Bardo": { hitDie: 8, skills: ['dex', 'cha'], skillOpts: 'any', saves: ['dex', 'cha'], slots: "full", subclassLevel: 3, features: [{name: "Inspira√ß√£o de Bardo", desc: "A√ß√£o b√¥nus: conceda um d6 a um aliado. (Carisma/descanso longo)."}, {name: "Conjura√ß√£o", desc: "Voc√™ conhece truques e magias. Carisma √© seu atributo."}, {name: "Pau pra Toda Obra", desc: "Adicione metade da profici√™ncia em testes que n√£o √© proficiente."}] },
            "Cl√©rigo": { hitDie: 8, skills: ['wis', 'cha'], skillOpts: [6, 8, 11, 14, 16], saves: ['wis', 'cha'], slots: "full", subclassLevel: 1, features: [{name: "Conjura√ß√£o", desc: "Prepara magias divinas. Sabedoria √© seu atributo."}, {name: "Canalizar Divindade", desc: "Efeito m√°gico divino (1/descanso curto). Turn Undead."}] },
            "Druida": { hitDie: 8, skills: ['wis', 'int'], skillOpts: [1, 2, 8, 11, 12, 16, 17], saves: ['int', 'wis'], slots: "full", subclassLevel: 2, features: [{name: "Dru√≠dico", desc: "Idioma secreto dos druidas."}, {name: "Conjura√ß√£o", desc: "Magias da natureza. Sabedoria √© seu atributo."}, {name: "Forma Selvagem", desc: "Transforme-se em uma fera (2/descanso curto)."}] },
            "Guerreiro": { hitDie: 10, skills: ['str', 'con'], skillOpts: [0, 2, 6, 9, 13, 17], saves: ['str', 'con'], slots: null, subclassLevel: 3, features: [{name: "Estilo de Luta", desc: "Especialize-se em um estilo de combate (Arco, Defesa, Duelismo, etc)."}, {name: "Retomar o F√¥lego", desc: "A√ß√£o b√¥nus: recupere 1d10 + n√≠vel PV (1/descanso curto)."}, {name: "Surto de A√ß√£o", desc: "Ganhe uma a√ß√£o extra (1/descanso curto)."}] },
            "Ladino": { hitDie: 8, skills: ['dex', 'int'], skillOpts: [0, 2, 4, 5, 8, 9, 13, 14, 15], saves: ['dex', 'int'], slots: null, subclassLevel: 3, features: [{name: "Ataque Furtivo", desc: "1d6 extra de dano (aumenta com n√≠vel) se tiver vantagem ou aliado a 1,5m."}, {name: "G√≠ria de Ladr√£o", desc: "Comunica√ß√£o secreta."}, {name: "A√ß√£o Astuta", desc: "A√ß√£o b√¥nus para Disparada, Desengajar ou Esconder."}] },
            "Mago": { hitDie: 6, skills: ['int', 'wis'], skillOpts: [1, 6, 8, 9, 11, 16], saves: ['int', 'wis'], slots: "full", subclassLevel: 2, features: [{name: "Conjura√ß√£o", desc: "Usa grim√≥rio. Intelig√™ncia √© seu atributo."}, {name: "Recupera√ß√£o Arcana", desc: "Recupere slots de magia em um descanso curto (metade do n√≠vel)."}] },
            "Monge": { hitDie: 8, skills: ['dex', 'wis'], skillOpts: [0, 2, 6, 8, 16, 5], saves: ['str', 'dex'], slots: null, subclassLevel: 3, features: [{name: "Defesa sem Armadura", desc: "CA = 10 + Des + Sab."}, {name: "Artes Marciais", desc: "Ataque desarmado com Des. Dano d4. Ataque extra com a√ß√£o b√¥nus."}, {name: "Ki", desc: "Pontos de Ki para habilidades especiais."}] },
            "Paladino": { hitDie: 10, skills: ['str', 'cha'], skillOpts: [2, 8, 11, 13, 14, 16], saves: ['wis', 'cha'], slots: "half", subclassLevel: 3, features: [{name: "Sentido Divino", desc: "A√ß√£o: detecte celestial, corruptor ou morto-vivo (1 + Car vezes)."}, {name: "Cura pelas M√£os", desc: "Piscina de cura = N√≠vel x 5."}, {name: "Destrui√ß√£o Divina", desc: "Gaste slot para 2d8 radiante extra."}] },
            "Patrulheiro": { hitDie: 10, skills: ['dex', 'wis'], skillOpts: [2, 5, 8, 9, 10, 11, 12, 17], saves: ['str', 'dex'], slots: "half", subclassLevel: 3, features: [{name: "Inimigo Favorito", desc: "Vantagem para rastrear e saber sobre um tipo."}, {name: "Explorador Natural", desc: "Benef√≠cios em terreno escolhido."}, {name: "Estilo de Luta", desc: "Especializa√ß√£o em combate (nv 2)."}] },
            "Feiticeiro": { hitDie: 6, skills: ['cha', 'con'], skillOpts: [1, 4, 8, 13, 14, 16], saves: ['con', 'cha'], slots: "full", subclassLevel: 1, features: [{name: "Conjura√ß√£o", desc: "Magia inata. Carisma √© seu atributo."}, {name: "Fonte de Magia", desc: "Pontos de Feiti√ßaria para criar slots."}] },
            "Bruxo": { hitDie: 8, skills: ['cha', 'wis'], skillOpts: [1, 4, 6, 7, 9, 12, 16], saves: ['wis', 'cha'], slots: "pact", subclassLevel: 1, features: [{name: "Magia de Pacto", desc: "Slots sempre no n√≠vel m√°ximo. Recuperam em descanso curto."}, {name: "Invocac√µes M√≠sticas", desc: "Poderes ocultos especiais (nv 2)."}] },
            "Art√≠fice": { hitDie: 8, skills: ['int', 'con'], skillOpts: [1, 6, 8, 9, 11, 12, 15], saves: ['con', 'int'], slots: "half", subclassLevel: 3, features: [{name: "Engenhosidade M√°gica", desc: "Use ferramentas como foco arcano."}, {name: "Infus√£o de Item", desc: "Torne itens mundanos em m√°gicos (nv 2)."}] }
        },
        races: { "Humano": { speed: "9m", traits: [{name: "Vers√°til", desc: "+1 todos atributos."}] } },
        items: [{name: "Adaga", weight: 0.5, desc: "Acuidade, Leve, Arremesso (6/18).", damage: "1d4 Perfurante"},{name: "Espada Curta", weight: 1, desc: "Acuidade, Leve.", damage: "1d6 Perfurante"}],
        spells: [{name: "M√£os M√°gicas", level: 0, desc: "M√£o espectral (9m).", type: "force"}]
    };

    // 2. FUN√á√ïES DE SETUP (HOISTED)
    function populateSelects() {
        const classSel = document.getElementById('char-class-select'); const raceSel = document.getElementById('char-race-select');
        Object.keys(SRD_LIB.classes).forEach(c => { const opt = document.createElement('option'); opt.value = c; opt.textContent = c; classSel.appendChild(opt); });
        classSel.appendChild(new Option("Personalizado", "custom"));
        Object.keys(SRD_LIB.races).forEach(r => { const opt = document.createElement('option'); opt.value = r; opt.textContent = r; raceSel.appendChild(opt); });
        raceSel.appendChild(new Option("Personalizado", "custom"));
    }
    function populateItemLib() {
        const sel = document.getElementById('item-library-select');
        SRD_LIB.items.forEach((item, idx) => { const opt = document.createElement('option'); opt.value = idx; opt.textContent = item.name + (item.ac ? ` (CA ${item.ac})` : '') + (item.damage ? ` (${item.damage})` : ''); sel.appendChild(opt); });
    }

    // --- API INTEGRATION ---
    async function searchSpellApi() {
        const query = document.getElementById('api-spell-search').value;
        const resultsDiv = document.getElementById('api-search-results');
        if(!query) return;
        
        resultsDiv.innerHTML = '<div class="text-center p-2"><div class="loader"></div></div>';
        resultsDiv.classList.remove('hidden');

        try {
            const response = await fetch(`https://www.dnd5eapi.co/api/spells/?name=${query}`);
            const data = await response.json();
            
            if(data.count === 0) {
                resultsDiv.innerHTML = '<div class="text-xs text-red-400 p-2">Nenhuma magia encontrada. Tente o nome em ingl√™s.</div>';
                return;
            }

            resultsDiv.innerHTML = '';
            data.results.forEach(spell => {
                const btn = document.createElement('button');
                btn.className = "w-full text-left text-xs bg-white/5 hover:bg-rpg-magic/20 p-2 rounded text-white border border-transparent hover:border-rpg-magic transition-colors";
                btn.textContent = spell.name;
                btn.onclick = () => fetchSpellDetails(spell.url);
                resultsDiv.appendChild(btn);
            });
        } catch (e) {
            resultsDiv.innerHTML = '<div class="text-xs text-red-400 p-2">Erro ao conectar na API.</div>';
        }
    }

    async function fetchSpellDetails(url) {
        const resultsDiv = document.getElementById('api-search-results');
        resultsDiv.innerHTML = '<div class="text-center p-2"><div class="loader"></div></div>';
        
        try {
            const response = await fetch(`https://www.dnd5eapi.co${url}`);
            const data = await response.json();
            
            // Mapeamento e Tradu√ß√£o B√°sica
            const level = data.level || 0;
            const name = data.name;
            const range = translateTerm(data.range);
            const duration = translateTerm(data.duration);
            const castingTime = translateTerm(data.casting_time);
            const components = data.components.join(', ');
            const desc = data.desc.join('\n\n');
            const higher = data.higher_level ? data.higher_level.join('\n') : "";
            
            // Tenta adivinhar o dano
            let damage = "";
            if (data.damage && data.damage.damage_at_slot_level) {
                damage = data.damage.damage_at_slot_level[level] || data.damage.damage_at_slot_level[level+1] || ""; 
            }
            
            // Mapeia escola para tipo visual
            let type = "utility";
            if(data.school.index === 'evocation') type = 'fire';
            if(data.school.index === 'necromancy') type = 'necrotic';
            if(data.school.index === 'abjuration') type = 'utility';
            if(data.school.index === 'restoration' || name.includes("Cure") || name.includes("Heal")) type = 'heal';

            createSpellCardElement(level, name, desc, damage, type, higher, castingTime, range, components, duration);
            
            resultsDiv.classList.add('hidden');
            closeSpellModal();
            
        } catch (e) {
            resultsDiv.innerHTML = '<div class="text-xs text-red-400 p-2">Erro nos detalhes da magia.</div>';
        }
    }

    function translateTerm(term) {
        const map = {
            "1 action": "1 A√ß√£o", "1 bonus action": "1 B√¥nus", "1 reaction": "1 Rea√ß√£o",
            "Instantaneous": "Instant√¢nea", "Concentration": "Concentra√ß√£o", 
            "Self": "Pessoal", "Touch": "Toque", "feet": "p√©s", "mile": "milha"
        };
        for (const [k, v] of Object.entries(map)) {
            if (term.includes(k)) term = term.replace(k, v);
        }
        return term;
    }

    function renderAttributes() { document.getElementById('attributes-container').innerHTML = attributes.map(a => `<div class="glass-panel p-2 rounded flex items-center justify-between group hover:border-rpg-accent transition-colors"><div class="text-center w-12"><span class="text-[9px] font-bold text-rpg-muted block uppercase">${a.abbr}</span><input type="number" id="score-${a.id}" value="10" class="w-full bg-transparent text-white font-bold text-lg text-center outline-none border-b border-transparent focus:border-rpg-accent"></div><span id="mod-${a.id}" class="text-2xl font-bold text-white group-hover:text-rpg-accent transition-colors">+0</span><div class="border-l border-gray-700 pl-2 text-center"><span class="text-[8px] text-gray-500 block uppercase">Salva</span><div class="flex items-center gap-1"><input type="checkbox" id="save-${a.id}" class="accent-rpg-accent w-3 h-3 cursor-pointer"><span id="save-val-${a.id}" class="text-xs font-bold text-gray-400">+0</span></div></div></div>`).join(''); }
    function renderSkills() { document.getElementById('skills-list').innerHTML = skills.map((s, i) => `<div class="flex items-center justify-between py-1 px-2 hover:bg-white/5 rounded transition-colors group skill-row" id="skill-row-${i}"><div class="flex items-center gap-2"><input type="checkbox" id="skill-${i}" data-attr="${s.attr}" class="accent-rpg-accent w-3 h-3 cursor-pointer" onclick="calculateAll(); checkSkillHighlight(this)"><span class="text-sm text-gray-400 group-hover:text-white transition-colors">${s.name} <span class="text-[9px] text-gray-600 uppercase ml-1">${s.attr}</span></span></div><span id="skill-val-${i}" class="text-sm font-bold text-gray-500 group-hover:text-rpg-accent transition-colors">+0</span></div>`).join(''); }
    
    function renderInventory(n) { 
        for(let i=0; i<n; i++) addInventoryRow(); 
    }
    
    function addInventoryRow() { 
        const id = 'inv-' + Date.now() + Math.random().toString(36).substr(2, 9); 
        const tr = document.createElement('tr'); 
        tr.className = "border-b border-gray-800/50 hover:bg-white/5 transition-colors"; 
        tr.setAttribute('data-row-id', id); 
        tr.innerHTML = `<td class="py-2 pl-3"><button class="text-gray-600 hover:text-white"><span class="material-symbols-outlined text-sm">backpack</span></button></td><td class="py-2 pl-2"><input class="w-full text-white text-sm" placeholder="Item Name"></td><td class="py-2 text-center"><input type="number" class="w-full text-center text-gray-400 text-sm qty-input" placeholder="1" oninput="calculateWeight()"></td><td class="py-2 text-right pr-3"><input type="number" class="w-full text-right text-gray-400 text-sm weight-input" placeholder="0" oninput="calculateWeight()"></td><td class="py-2 text-center"><button onclick="openItemEditor(this)" class="text-gray-600 hover:text-white"><span class="material-symbols-outlined text-sm">edit</span></button></td>`; 
        document.getElementById('inventory-rows').appendChild(tr); 
    }
    
    function cycleIcon(btn, list) { let idx = parseInt(btn.dataset.idx) || 0; idx = (idx + 1) % list.length; btn.dataset.idx = idx; btn.querySelector('span').textContent = list[idx]; }
    
    function addQuickSlot(times=1) { /* ... same ... */ }

    // --- FUN√á√ïES DE SETUP (MANTIDAS) ---
    function initSpellbook() { const c = document.getElementById('spell-levels-container'); if(c.children.length > 0) return; c.innerHTML += createSpellLevelSection(0, Infinity); for(let i=1; i<=9; i++) c.innerHTML += createSpellLevelSection(i, defaultSlots[i-1]); }
    function createSpellLevelSection(level, slots) { const title = level === 0 ? "Truques (N√≠vel 0)" : `C√≠rculo ${level}`; return `<div class="bg-black/20 border border-gray-800 rounded-xl overflow-hidden" id="spell-group-${level}"><div class="flex justify-between items-center p-3 bg-white/5 cursor-pointer hover:bg-white/10 transition-colors" onclick="this.parentElement.querySelector('.collapsible').classList.toggle('hidden')"><h4 class="text-rpg-magic font-bold text-sm flex items-center gap-2"><span class="material-symbols-outlined text-base">expand_more</span> ${title}</h4><div class="flex items-center gap-3">${level > 0 ? `<div class="flex gap-1">${generateCheckboxes(slots)}</div>` : ''}<button class="text-xs bg-rpg-magic/20 text-rpg-magic px-2 py-1 rounded hover:bg-rpg-magic hover:text-black transition-colors" onclick="event.stopPropagation(); openSpellModal(${level})">+ Adicionar</button></div></div><div class="collapsible p-3 grid grid-cols-1 md:grid-cols-2 gap-3" id="spells-lvl-${level}"></div></div>`; }
    function generateCheckboxes(n) { return Array(parseInt(n)||0).fill('<input type="checkbox" class="spell-slot-check">').join(''); }
    function updateSpellSlotCheckboxes(input) { input.previousElementSibling.innerHTML = generateCheckboxes(input.value); }
    function moveSpellCard(select) { const ol=parseInt(select.closest('[id^="spells-lvl-"]').id.split('-')[2]); const nl=parseInt(select.value); if(ol===nl)return; const c=select.closest('.group'); c.querySelector('button').setAttribute('onclick', `this.closest('.group').remove(); updateSpellCount(${nl})`); document.getElementById(`spells-lvl-${nl}`).appendChild(c); updateSpellCount(ol); updateSpellCount(nl); }
    function updateSpellType(sel) { const d=damageTypes.find(x=>x.val===sel.value); const c=sel.closest('.group').querySelector('.spell-icon-container'); c.querySelector('span').textContent=d.icon; c.className=`spell-icon-container w-8 h-8 rounded bg-black flex-shrink-0 flex items-center justify-center border border-gray-600 transition-colors ${d.color}`; }
    function addPassiveCard(t,d,i, origin) { /* ... same ... */ }
    function addPassive() { addPassiveCard('','',0); }
    function cyclePassiveType(btn) { /* ... same ... */ }
    function calculateWeight() { let t = 0; document.querySelectorAll('#inventory-rows tr').forEach(r => { t += (parseFloat(r.querySelector('.qty-input').value)||0) * (parseFloat(r.querySelector('.weight-input').value)||0); }); document.querySelectorAll('#inventory-equipped-rows tr').forEach(r => { t += parseFloat(r.querySelector('.text-right').textContent)||0; }); const d = document.getElementById('weight-display'); const max = parseFloat(document.getElementById('max-weight').textContent) || 0; d.innerHTML = `${t.toFixed(1)} / <span id="max-weight">${max}</span> kg`; d.className = t > max ? "font-bold text-sm text-rpg-red animate-pulse" : "font-bold text-sm text-gray-300"; }
    function toggleAttune(el) { el.classList.toggle('active'); updateAttunement(); updateInventoryFromEquipment(); } 
    function updateAttunement() { const c = document.querySelectorAll('.attunement-indicator.active').length; const m = parseInt(document.getElementById('attunement-max').value)||3; const d = document.getElementById('attunement-count'); d.textContent = c; d.className = c > m ? "text-xl font-bold text-rpg-red animate-pulse" : "text-xl font-bold text-white"; }
    
    // --- AUTOMATIZA√á√ÉO DE CLASSE (Restaurado Skill Opts e Passivas) ---
    function updateClassFeatures() {
        const className = document.getElementById('char-class-select').value;
        const level = parseInt(document.getElementById('char-level').value) || 1;
        const hint = document.getElementById('skill-hint');
        const subclassContainer = document.getElementById('subclass-container');
        
        document.querySelectorAll('.skill-row').forEach(row => row.classList.remove('suggestion-ring'));
        hint.classList.add('hidden');
        document.querySelectorAll('.glass-panel[data-origin="class"]').forEach(el => el.remove());

        if (className && SRD_LIB.classes[className]) {
            const data = SRD_LIB.classes[className];
            if (data.slots) {
                const table = SRD_LIB.slots[data.slots];
                const slotsForLevel = table[Math.min(level, 20) - 1];
                defaultSlots = slotsForLevel; 
                for(let i=0; i<9; i++) {
                    const input = document.querySelector(`#spell-group-${i+1} .slot-max-input`);
                    if(input) { input.value = slotsForLevel[i]; updateSpellSlotCheckboxes(input); }
                }
            }
            
            // Passivas B√°sicas
            if(data.features) {
                data.features.forEach(feat => addPassiveCard(feat.name, feat.desc, 0, "class"));
            }

            // Per√≠cias (L√≥gica de Highlight Restaurada)
            if (data.skillOpts && data.skillOpts !== 'any') {
                hint.classList.remove('hidden');
                data.skillOpts.forEach(idx => {
                    const row = document.getElementById(`skill-row-${idx}`);
                    // Adiciona se n√£o estiver checado
                    if(row && !row.querySelector('input').checked) {
                        row.classList.add('suggestion-ring');
                    }
                });
            }
        }
    }

    function updateRaceFeatures() { /* ... same ... */ }
    
    // IMPORTANTE: Fun√ß√£o para remover o highlight quando o usu√°rio clica
    function checkSkillHighlight(checkbox) { 
        if(checkbox.checked) {
            checkbox.closest('.skill-row').classList.remove('suggestion-ring');
        }
    }

    function openSpellModal(level) { /* ... same ... */ }
    function closeSpellModal() { document.getElementById('spell-selector-modal').classList.remove('open'); }
    function addCustomSpell() { /* ... same ... */ }
    function addSelectedSpellFromLib() { /* ... same ... */ }
    function createSpellCardElement(level, name, desc, dmg, typeVal, higher, time, range, comps, dur) { /* ... same ... */ }
    function importItemFromLib(select) { /* ... same ... */ }
    function openItemEditor(element) { /* ... same ... */ }
    function closeItemEditor() { document.getElementById('item-editor-modal').classList.remove('open'); }
    function saveItemEditor() { /* ... same ... */ }
    function updateInventoryFromEquipment() { /* ... same ... */ }
    function getGlobalEquipmentBonuses() { let t = { ac: 0, atk: 0, dmg: 0, dc: 0 }; for (const k in equipmentData) { const i = equipmentData[k]; if (i) { t.ac+=i.ac||0; t.atk+=i.atk||0; t.dmg+=i.dmg||0; t.dc+=i.dc||0; } } return t; }
    function calculateAll() { /* ... same ... */ }
    
    // --- FUN√á√ÉO DE COMBATE RECUPERADA (C√°lculo Complexo de Dano) ---
    function updateCombatRow(row, mods, pb, eb) {
        if(!mods || !pb) { 
            const lvl=parseInt(document.getElementById('char-level').value)||1; 
            pb=Math.ceil(lvl/4)+1; 
            mods={}; 
            attributes.forEach(a=>mods[a.id]=Math.floor(((parseInt(document.getElementById(`score-${a.id}`).value)||10)-10)/2));
            eb = getGlobalEquipmentBonuses();
        }
        
        const attr = row.querySelector('.attr-select').value; 
        const magic = parseInt(row.querySelector('.magic-bonus-input').value)||0; 
        const prof = row.querySelector('.prof-check').checked;
        
        // Acerto: Mod + Prof + MagicoItem + GlobalEquip
        const hit = (mods[attr]||0) + (prof?pb:0) + magic + (eb.atk || 0); 
        row.querySelector('.attack-bonus').textContent = hit>=0?`+${hit}`:hit;
        
        // Dano Base Num√©rico
        const dmgBaseNum = (mods[attr]||0) + magic + (eb.dmg || 0); 
        
        // Totalizador de Dados (Regex simples para somar dados iguais)
        const baseD = row.querySelector('.base-dmg-input').value; 
        // Se houver linhas extras no futuro, coletar√≠amos aqui
        
        let groups = {}; 
        const add = (d) => { 
            if(!d) return; 
            // Tenta achar XdY
            const m = d.match(/(\d+)d(\d+)/i); 
            if(m) { 
                const k = `d${m[2]}`; 
                if(!groups[k]) groups[k]=0; 
                groups[k] += parseInt(m[1]); 
            } else if(d.match(/^\d+$/)) { 
                // Dano fixo extra escrito na caixa
                dmgBaseNum += parseInt(d);
            } 
        };
        add(baseD); 
        
        let out = []; 
        for (let k in groups) { 
            out.push(`${groups[k]}${k}`); 
        }
        
        if(dmgBaseNum !== 0 || out.length === 0) {
            out.push(`${dmgBaseNum >= 0 && out.length > 0 ? '+' : ''}${dmgBaseNum}`);
        }
        
        const finalString = out.join(' + ');
        
        // Atualiza a coluna principal de Dano Total
        const display = row.querySelector('.damage-total-display');
        if(display) {
            display.textContent = finalString;
            display.style.fontSize = finalString.length > 5 ? '0.7rem' : '1rem'; 
        }
    }

    function loadPortrait(event) { /* ... same ... */ }
    function downloadSheet() { /* ... same ... */ }
    
    // --- ADD COMBAT ROW ATUALIZADO (Inclui input types e classes para o calculo) ---
    function addCombatRow(n=1) {
        const b = document.getElementById('combat-rows');
        for(let i=0;i<n;i++) {
            const tr = document.createElement('tr'); 
            tr.className = "combat-row border-b border-gray-800 hover:bg-white/5 transition-colors group";
            tr.innerHTML = `
                <td class="p-3 w-8 text-center"><button class="text-gray-500 hover:text-white transition-transform duration-300"><span class="material-symbols-outlined text-sm rotate-chevron">expand_more</span></button></td>
                <td class="p-3 text-center"><button onclick="cycleCombatIconBtn(this)" class="text-gray-400 hover:text-white transition-colors"><span class="material-symbols-outlined text-lg">swords</span></button></td>
                <td class="p-3 text-center"><input type="checkbox" class="accent-rpg-combat w-4 h-4 cursor-pointer prof-check" onchange="calculateAll()"></td>
                <td class="p-3"><input class="bg-transparent w-full font-bold text-white outline-none placeholder-gray-600" placeholder="Arma"></td>
                <td class="p-3"><select class="bg-black/40 text-gray-300 text-xs rounded p-1 outline-none border border-gray-700 attr-select w-full" onchange="calculateAll()"><option value="str">FOR</option><option value="dex">DES</option><option value="con">CON</option><option value="int">INT</option><option value="wis">SAB</option><option value="cha">CAR</option></select></td>
                <td class="p-3 text-center"><input type="number" class="magic-bonus-input bg-transparent w-full text-center text-rpg-magic font-bold outline-none placeholder-gray-800" placeholder="+0" oninput="calculateAll()"></td>
                <td class="p-3 text-center bg-rpg-accent/5 rounded"><span class="font-bold text-lg text-rpg-accent attack-bonus">+0</span></td>
                <td class="p-3"><input class="base-dmg-input bg-transparent w-full text-white outline-none placeholder-gray-600 text-center" placeholder="1d8" oninput="calculateAll()"></td>
                <td class="p-3 text-left bg-rpg-combat/5 rounded"><span class="font-bold text-lg text-rpg-combat damage-total-display">--</span></td>
                <td class="p-3"><input class="base-type-input bg-transparent w-full text-gray-400 outline-none placeholder-gray-600 text-xs" placeholder="Tipo"></td>
                <td class="p-3 text-center"><button onclick="this.closest('tr').remove()" class="text-gray-600 hover:text-rpg-red opacity-0 group-hover:opacity-100">√ó</button></td>`;
            b.appendChild(tr);
        }
    }
    
    // Assegurando que todas as fun√ß√µes auxiliares estejam presentes (re-implementa√ß√£o breve das essenciais omitidas acima para brevidade mas cruciais para o funcionamento)
    function addPassiveCard(t,d,i, origin) { 
        const div = document.createElement('div'); const type = passiveTypes[i]||passiveTypes[0]; 
        div.className = `glass-panel border-l-4 ${type.border} p-3 rounded shadow-lg relative group animate-up transition-transform hover:-translate-y-1 h-full flex flex-col min-h-[160px]`;
        if(origin) div.setAttribute('data-origin', origin);
        div.innerHTML = `<div class="flex items-center justify-between mb-2"><div class="flex items-center gap-2 flex-grow"><button onclick="cyclePassiveType(this)" class="w-6 h-6 rounded-full ${type.color} flex items-center justify-center text-black font-bold transition-colors shrink-0" data-idx="${i}"><span class="material-symbols-outlined text-sm">${type.icon}</span></button><span class="passive-badge bg-black/50 border border-gray-700 ${type.textColor}">${type.label}</span></div><button onclick="this.closest('.glass-panel').remove()" class="text-gray-600 hover:text-rpg-red opacity-0 group-hover:opacity-100"><span class="material-symbols-outlined text-sm">close</span></button></div><input class="bg-transparent font-bold text-white w-full outline-none border-b border-transparent focus:border-rpg-muted mb-1" value="${t}" placeholder="Nome"><textarea class="bg-transparent w-full text-sm text-gray-300 resize-none h-20 outline-none custom-scrollbar flex-grow" placeholder="Descri√ß√£o...">${d}</textarea>`; 
        document.getElementById('passives-grid').appendChild(div); 
    }
    
    function cyclePassiveType(btn) { 
        let idx=(parseInt(btn.dataset.idx)+1)%passiveTypes.length; btn.dataset.idx=idx; const t=passiveTypes[idx]; const c=btn.closest('.glass-panel'); 
        btn.className=`w-6 h-6 rounded-full ${t.color} flex items-center justify-center text-black font-bold transition-colors shrink-0`; c.className=`glass-panel border-l-4 ${t.border} p-3 rounded shadow-lg relative group animate-up transition-transform hover:-translate-y-1 h-full flex flex-col min-h-[160px]`; btn.querySelector('span').textContent=t.icon; const badge = c.querySelector('.passive-badge'); badge.className = `passive-badge bg-black/50 border border-gray-700 ${t.textColor}`; badge.textContent = t.label; 
    }

    // 3. INICIALIZA√á√ÉO
    document.addEventListener('DOMContentLoaded', () => {
        populateSelects(); 
        populateItemLib(); 
        renderAttributes(); 
        renderSkills(); 
        renderInventory(5); 
        addQuickSlot(3); 
        addCombatRow(2); 
        initSpellbook(); 
        
        document.querySelectorAll('.equip-input').forEach(input => {
            const slot = input.dataset.slot;
            if(input.value && !equipmentData[slot]) {
                equipmentData[slot] = {
                    name: input.value, desc: input.getAttribute('data-desc') || "", weight: parseFloat(input.getAttribute('data-weight')) || 0,
                    ac: parseInt(input.getAttribute('data-bonus-ac')) || 0, atk: parseInt(input.getAttribute('data-bonus-atk')) || 0,
                    dmg: parseInt(input.getAttribute('data-bonus-dmg')) || 0, dc: parseInt(input.getAttribute('data-bonus-dc')) || 0
                };
                if(equipmentData[slot].ac || equipmentData[slot].atk || equipmentData[slot].dmg) input.classList.add('has-stats');
            }
        });
        document.querySelectorAll('#inventory-rows tr').forEach(tr => {
            const id = tr.getAttribute('data-row-id'); const desc = tr.getAttribute('data-desc'); if(id && desc) inventoryData[id] = { desc: desc };
        });
        
        calculateAll(); 
        updateInventoryFromEquipment();
        
        document.body.addEventListener('input', (e) => {
            if(e.target.matches('input, select')) {
                calculateAll();
                if(e.target.classList.contains('weight-calc')) calculateWeight();
                if(e.target.classList.contains('slot-max-input')) updateSpellSlotCheckboxes(e.target);
                if(e.target.closest('.combat-row') || e.target.closest('.collapsible-content')) updateCombatRow(e.target.closest('tr').previousElementSibling || e.target.closest('tr'));
            }
        });
    });
</script>

</body>
</html>