<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="utf-8">
    <meta content="width=device-width, initial-scale=1.0" name="viewport">
    <title>Ficha D&D 5e - Mestre do Arsenal (Fantasy Edition)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Importando Cinzel (T√≠tulos) e Crimson Text (Corpo/Leitura) -->
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700;900&amp;family=Crimson+Text:ital,wght@0,400;0,600;0,700;1,400&amp;family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,1,0" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        rpg: {
                            dark: '#0c0a09',      /* Stone 950 - Fundo Geral */
                            panel: '#1c1917',     /* Stone 900 - Pain√©is */
                            accent: '#d4af37',    /* Gold - Destaques */
                            text: '#e7e5e4',      /* Stone 200 - Texto Principal */
                            muted: '#a8a29e',     /* Stone 400 - Texto Secund√°rio */
                            red: '#991b1b',       /* Red 800 - Vida/Sangue (Mais escuro/s√©rio) */
                            gold: '#fbbf24',      /* Amber 400 - Ouro Brilhante */
                            combat: '#7f1d1d',    /* Red 900 - Combate */
                            magic: '#9333ea',     /* Purple 600 - Magia */
                            scroll: '#f5f5dc',    /* Bege Pergaminho (para inputs claros) */
                        }
                    },
                    fontFamily: {
                        header: ['Cinzel', 'serif'],
                        body: ['Crimson Text', 'serif'],
                    },
                    boxShadow: {
                        'parchment': '0 4px 20px rgba(0, 0, 0, 0.6), inset 0 0 40px rgba(0, 0, 0, 0.2)',
                        'gold-glow': '0 0 10px rgba(212, 175, 55, 0.3)',
                        'inset': 'inset 0 2px 4px 0 rgba(0, 0, 0, 0.6)'
                    },
                    backgroundImage: {
                        'texture': "url('https://www.transparenttextures.com/patterns/dark-leather.png')",
                    }
                }
            }
        }
    </script>
    <style>
        body { 
            background-color: #0c0a09;
            background-image: radial-gradient(circle at 50% 0%, #292524 0%, #0c0a09 80%);
            color: #e7e5e4;
        }
        
        /* Estiliza√ß√£o de Scrollbar (Dourada) */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #0c0a09; border-left: 1px solid #333; }
        ::-webkit-scrollbar-thumb { background: #44403c; border: 1px solid #d4af37; border-radius: 2px; }
        ::-webkit-scrollbar-thumb:hover { background: #d4af37; }
        
        /* Inputs e Selects Estilizados (Pergaminho/Fantasia) */
        input, select, textarea { 
            transition: all 0.3s ease; 
            background: transparent; 
            font-family: 'Crimson Text', serif;
            color: #d4af37;
        }
        input:focus, select:focus, textarea:focus { 
            outline: none; 
            border-bottom-color: #d4af37; 
            background: rgba(212, 175, 55, 0.05); 
            text-shadow: 0 0 5px rgba(212, 175, 55, 0.3);
        }
        input::placeholder, textarea::placeholder { color: #57534e; font-style: italic; }
        select option { background-color: #1c1917; color: #e7e5e4; padding: 8px; font-family: 'Crimson Text', serif; }
        input[type=number]::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }

        /* Pain√©is com Borda Dourada Fina */
        .fantasy-panel {
            background-color: rgba(28, 25, 23, 0.85); /* Stone 900 com transpar√™ncia */
            border: 1px solid #44403c; /* Stone 700 */
            border-bottom: 2px solid #292524;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.5), 0 2px 4px -1px rgba(0, 0, 0, 0.3);
            border-radius: 4px;
            position: relative;
        }
        .fantasy-panel::before {
            content: '';
            position: absolute;
            top: 0; left: 0; right: 0; height: 1px;
            background: linear-gradient(90deg, transparent, #d4af37, transparent);
            opacity: 0.5;
        }

        /* Abas Estilo Livro Antigo */
        .tab-btn {
            font-family: 'Cinzel', serif;
            font-weight: 700;
            color: #78716c; /* Muted */
            border-bottom: 2px solid transparent;
            padding: 0.5rem 1rem;
            transition: all 0.3s;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            position: relative;
        }
        .tab-btn:hover { color: #d4af37; text-shadow: 0 0 8px rgba(212, 175, 55, 0.4); }
        .tab-btn.active { 
            color: #d4af37; 
            border-bottom-color: #d4af37;
            background: linear-gradient(to top, rgba(212, 175, 55, 0.1), transparent);
        }
        .tab-btn.active::after {
            content: '‚ô¶';
            position: absolute;
            bottom: -7px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 10px;
            color: #d4af37;
        }

        /* Conte√∫do das Abas */
        .tab-content { display: none; animation: fadeIn 0.4s ease-out; }
        .tab-content.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        /* Highlight de Sugest√£o (Brilho Dourado) */
        .suggestion-ring { 
            box-shadow: inset 0 0 10px rgba(212, 175, 55, 0.3), 0 0 5px rgba(212, 175, 55, 0.5);
            border: 1px solid #d4af37 !important;
            animation: pulse-gold 2s infinite; 
        }
        @keyframes pulse-gold { 
            0% { box-shadow: 0 0 0 0px rgba(212, 175, 55, 0.4); } 
            70% { box-shadow: 0 0 0 4px rgba(212, 175, 55, 0); } 
            100% { box-shadow: 0 0 0 0px rgba(212, 175, 55, 0); } 
        }

        /* Inputs de Equipamento */
        .equip-slot-container { position: absolute; display: flex; align-items: center; transition: all 0.3s; z-index: 10; }
        .equip-input { 
            background: rgba(12, 10, 9, 0.9); 
            border: 1px solid #44403c; 
            color: #e7e5e4; 
            font-size: 0.75rem; 
            padding: 4px 8px; 
            border-radius: 2px; 
            width: 120px; 
            text-align: center; 
            box-shadow: 0 2px 4px rgba(0,0,0,0.5);
            font-family: 'Crimson Text', serif;
            font-weight: 600;
        }
        .equip-input:hover, .equip-input:focus { 
            border-color: #d4af37; 
            color: #d4af37; 
            width: 130px; 
            box-shadow: 0 0 8px rgba(212, 175, 55, 0.2); 
        }
        .equip-input.has-stats { border-color: #fbbf24; color: #fbbf24; }
        .slot-label { 
            position: absolute; top: -16px; left: 50%; transform: translateX(-50%); 
            font-size: 0.6rem; color: #a8a29e; text-transform: uppercase; 
            font-family: 'Cinzel', serif; font-weight: bold; pointer-events: none; white-space: nowrap; 
            text-shadow: 0 1px 2px black;
        }
        
        /* Toggle e Checkbox */
        .combat-toggle { width: 18px; height: 18px; border: 1px solid #57534e; border-radius: 2px; cursor: pointer; display: flex; align-items: center; justify-content: center; background: #0c0a09; }
        .combat-toggle:hover { border-color: #d4af37; }
        .combat-toggle.active { background: #7f1d1d; border-color: #991b1b; color: white; box-shadow: 0 0 5px #7f1d1d; }
        .combat-toggle.active::after { content: '‚öî'; font-size: 12px; }

        .attunement-indicator { width: 10px; height: 10px; border: 1px solid #57534e; background: #0c0a09; border-radius: 50%; margin: 0 6px; cursor: pointer; }
        .attunement-indicator.active { background: #9333ea; border-color: #d8b4fe; box-shadow: 0 0 6px #9333ea; }

        /* Modal */
        .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.9); backdrop-filter: blur(4px); z-index: 100; display: none; align-items: center; justify-content: center; }
        .modal-overlay.open { display: flex; animation: fadeIn 0.2s; }

        /* Badges */
        .tag-badge { font-size: 0.6rem; padding: 1px 5px; border-radius: 2px; text-transform: uppercase; font-family: 'Cinzel', serif; font-weight: bold; margin-right: 4px; display: inline-flex; align-items: center; gap: 2px; border: 1px solid; }
        .tag-equipped { background: rgba(212, 175, 55, 0.1); color: #d4af37; border-color: rgba(212, 175, 55, 0.3); }
        .tag-attuned { background: rgba(147, 51, 234, 0.1); color: #c084fc; border-color: rgba(147, 51, 234, 0.3); }
        .passive-badge { font-size: 0.55rem; padding: 2px 6px; border-radius: 2px; text-transform: uppercase; font-family: 'Cinzel', serif; font-weight: bold; display: inline-block; margin-bottom: 4px; border: 1px solid; }
        
        .loader { border: 2px solid #292524; border-top: 2px solid #d4af37; border-radius: 50%; width: 20px; height: 20px; animation: spin 1s linear infinite; display: inline-block; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        .collapsible-content { transition: max-height 0.4s ease-out, opacity 0.4s ease-out; max-height: 0; overflow: hidden; opacity: 0; }
        .collapsible-content.open { max-height: 2000px; opacity: 1; }
        .rotate-chevron { transition: transform 0.3s; }
        .rotate-chevron.open { transform: rotate(180deg); }
    </style>
</head>
<body class="font-body text-lg p-2 md:p-6 pb-32">

    <!-- MENU FLUTUANTE (SALVAR) -->
    <div class="fixed bottom-6 right-6 z-50 flex flex-col gap-3">
        <button onclick="downloadSheet()" class="bg-rpg-accent text-rpg-dark font-bold p-4 rounded-full shadow-lg hover:bg-white hover:scale-110 transition-all flex items-center justify-center group border-2 border-yellow-600" title="Salvar Ficha">
            <span class="material-symbols-outlined text-3xl group-hover:rotate-12 transition-transform">save</span>
        </button>
    </div>

    <!-- MODAL EDITOR DE ITEM -->
    <div id="item-editor-modal" class="modal-overlay">
        <div class="fantasy-panel w-[95%] max-w-lg p-6 relative">
            <div class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-transparent via-rpg-accent to-transparent"></div>
            <h3 class="font-header text-3xl text-rpg-accent mb-6 flex items-center gap-3 border-b border-gray-700 pb-2">
                <span class="text-white"><span class="material-symbols-outlined text-3xl">edit_square</span></span>
                Forjar Equipamento
            </h3>
            <input type="hidden" id="modal-target-id"> <input type="hidden" id="modal-context-type"> 
            
            <div class="space-y-5">
                <div class="bg-black/40 p-3 rounded border border-dashed border-gray-600">
                    <label class="text-xs uppercase text-rpg-accent font-bold block mb-2 tracking-wider">üìö Comp√™ndio de Itens</label>
                    <select id="item-library-select" class="w-full bg-[#1c1917] text-gray-300 p-2 rounded border border-gray-600 text-base focus:border-rpg-accent cursor-pointer" onchange="importItemFromLib(this)">
                        <option value="">-- Selecione um Modelo --</option>
                    </select>
                </div>

                <div class="flex gap-4">
                    <div class="flex-grow">
                        <label class="text-xs uppercase text-gray-500 font-bold mb-1 block font-header">Nome do Item</label>
                        <input id="modal-item-name" class="w-full bg-black/30 text-white p-2 rounded border border-gray-700 focus:border-rpg-accent text-lg font-bold" placeholder="Ex: Espada Longa +1">
                    </div>
                    <div class="w-24">
                        <label class="text-xs uppercase text-gray-500 font-bold mb-1 block font-header">Peso (kg)</label>
                        <input id="modal-item-weight" type="number" step="0.1" class="w-full bg-black/30 text-white p-2 rounded border border-gray-700 focus:border-rpg-accent text-lg text-center" placeholder="0.0">
                    </div>
                </div>
                <div>
                    <label class="text-xs uppercase text-gray-500 font-bold mb-1 block font-header">Descri√ß√£o &amp; Propriedades</label>
                    <textarea id="modal-item-desc" class="w-full bg-black/30 text-gray-300 p-3 rounded border border-gray-700 focus:border-rpg-accent text-base resize-none h-32 custom-scrollbar" placeholder="Descreva os efeitos m√°gicos ou mec√¢nicos..."></textarea>
                </div>
                
                <div id="modal-bonuses-section" class="bg-black/20 p-4 rounded border border-gray-700">
                    <label class="text-xs uppercase text-rpg-gold font-bold mb-3 block flex items-center gap-2 font-header">
                        <span class="material-symbols-outlined text-sm">auto_awesome</span> B√¥nus M√°gicos (Ao Equipar)
                    </label>
                    <div class="grid grid-cols-4 gap-3">
                        <div class="text-center"><label class="text-[10px] text-gray-500 block mb-1">CA</label><input id="modal-bonus-ac" type="number" class="w-full bg-black/40 border border-gray-600 rounded text-rpg-accent font-bold text-center py-1 focus:border-rpg-gold" placeholder="0"></div>
                        <div class="text-center"><label class="text-[10px] text-gray-500 block mb-1">ATQ</label><input id="modal-bonus-atk" type="number" class="w-full bg-black/40 border border-gray-600 rounded text-rpg-accent font-bold text-center py-1 focus:border-rpg-gold" placeholder="0"></div>
                        <div class="text-center"><label class="text-[10px] text-gray-500 block mb-1">DANO</label><input id="modal-bonus-dmg" type="number" class="w-full bg-black/40 border border-gray-600 rounded text-rpg-accent font-bold text-center py-1 focus:border-rpg-gold" placeholder="0"></div>
                        <div class="text-center"><label class="text-[10px] text-gray-500 block mb-1">CD</label><input id="modal-bonus-dc" type="number" class="w-full bg-black/40 border border-gray-600 rounded text-rpg-accent font-bold text-center py-1 focus:border-rpg-gold" placeholder="0"></div>
                    </div>
                </div>
            </div>

            <div class="flex justify-end gap-3 mt-8 pt-4 border-t border-gray-700">
                <button onclick="closeItemEditor()" class="px-5 py-2 rounded text-gray-400 hover:text-white transition-colors text-base font-header">Cancelar</button>
                <button onclick="saveItemEditor()" class="px-6 py-2 rounded bg-rpg-accent text-rpg-dark font-bold hover:bg-white hover:text-black shadow-gold-glow transition-all transform hover:-translate-y-0.5 text-base font-header">Salvar Altera√ß√µes</button>
            </div>
        </div>
    </div>

    <!-- MODAL DE SELE√á√ÉO DE MAGIA -->
    <div id="spell-selector-modal" class="modal-overlay">
        <div class="fantasy-panel w-[95%] max-w-lg p-6 relative">
            <h3 class="font-header text-3xl text-rpg-magic mb-6 flex items-center gap-3 border-b border-gray-700 pb-2">
                <span class="text-white"><span class="material-symbols-outlined text-3xl">auto_stories</span></span>
                Inscrever Feiti√ßo
            </h3>
            <input type="hidden" id="modal-spell-level"> 
            
            <div class="space-y-4">
                <div class="bg-rpg-magic/5 p-3 rounded border border-rpg-magic/20">
                    <label class="text-xs uppercase text-rpg-magic font-bold block mb-2 flex justify-between font-header">
                        <span>üåê Pesquisa Arcana (Online)</span>
                        <span class="text-[10px] text-gray-500 normal-case font-body">D&D 5e API (Ingl√™s)</span>
                    </label>
                    <div class="flex gap-2">
                        <input id="api-spell-search" class="w-full bg-black/50 text-white p-2 rounded border border-gray-600 text-base focus:border-rpg-magic font-body" placeholder="Ex: Fireball, Cure Wounds..." onkeypress="if(event.key==='Enter') searchSpellApi()">
                        <button onclick="searchSpellApi()" class="bg-rpg-magic text-black font-bold px-3 rounded hover:bg-white transition-colors"><span class="material-symbols-outlined text-lg">search</span></button>
                    </div>
                    <div id="api-search-results" class="mt-2 max-h-40 overflow-y-auto custom-scrollbar hidden space-y-1 bg-black/80 rounded border border-gray-700"></div>
                </div>

                <div class="relative flex py-2 items-center">
                    <div class="flex-grow border-t border-gray-800"></div>
                    <span class="flex-shrink mx-4 text-gray-500 text-xs font-header">OU</span>
                    <div class="flex-grow border-t border-gray-800"></div>
                </div>

                <div class="bg-black/30 p-3 rounded border border-dashed border-gray-600">
                    <label class="text-xs uppercase text-rpg-muted font-bold block mb-2 font-header">Grim√≥rio Padr√£o (PT-BR) <span id="spell-class-filter-display" class="text-white ml-1 opacity-50 font-normal"></span></label>
                    <select id="spell-library-select" class="w-full bg-[#1c1917] text-white p-2 rounded border border-gray-600 text-base focus:border-rpg-magic cursor-pointer">
                        <option value="">-- Selecione da Lista --</option>
                    </select>
                </div>
                
                <div class="grid grid-cols-2 gap-4 pt-2">
                    <button onclick="addSelectedSpellFromLib()" class="bg-rpg-magic/10 border border-rpg-magic text-rpg-magic font-bold py-3 rounded hover:bg-rpg-magic hover:text-black transition-colors flex items-center justify-center gap-2 font-header">
                        Adicionar (PT-BR)
                    </button>
                    <button onclick="addCustomSpell()" class="bg-transparent border border-gray-500 text-gray-400 font-bold py-3 rounded hover:border-white hover:text-white transition-colors flex items-center justify-center gap-2 font-header">
                        Criar Vazio
                    </button>
                </div>
            </div>
            <div class="flex justify-center mt-6">
                <button onclick="closeSpellModal()" class="text-gray-500 hover:text-white text-sm underline font-header">Fechar Grim√≥rio</button>
            </div>
        </div>
    </div>

    <!-- CABE√áALHO DO PERSONAGEM -->
    <header class="max-w-7xl mx-auto mb-8 pt-6 flex flex-col md:flex-row gap-6 md:items-end border-b border-gray-800 pb-6 animate-up">
        <div class="flex items-center gap-6 flex-grow">
            <div class="relative group w-28 h-28 rounded shadow-gold-glow bg-black cursor-pointer shrink-0 border border-[#44403c] overflow-hidden">
                <img class="w-full h-full object-cover opacity-90 group-hover:opacity-100 transition-opacity" id="char-portrait" src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='100' height='100' viewBox='0 0 100 100'%3E%3Crect width='100' height='100' fill='%231c1917'/%3E%3Cpath d='M50 30a15 15 0 1 1 0 30 15 15 0 0 1 0-30zm0 35c15 0 30 10 30 25v10H20V90c0-15 15-25 30-25z' fill='%2344403c'/%3E%3C/svg%3E">
                <div class="absolute inset-0 flex items-center justify-center bg-black/60 opacity-0 group-hover:opacity-100 transition-opacity">
                    <span class="material-symbols-outlined text-rpg-accent text-3xl">add_a_photo</span>
                </div>
                <input accept="image/*" class="absolute inset-0 opacity-0 cursor-pointer" onchange="loadPortrait(event)" type="file">
            </div>
            
            <div class="flex-grow space-y-2">
                <div class="relative">
                    <label class="text-[10px] uppercase text-rpg-accent tracking-widest font-header absolute -top-3 left-0">Nome do Personagem</label>
                    <input id="char-name" class="w-full bg-transparent text-4xl md:text-5xl text-white font-header border-none p-0 focus:ring-0 placeholder-gray-800" placeholder="Heroi" value="">
                </div>
                <div class="flex gap-4 text-base text-gray-400 font-header">
                    <div class="flex items-center gap-2 border-b border-gray-700 px-1">
                        <select id="char-class-select" onchange="updateClassFeatures()" class="bg-transparent outline-none cursor-pointer text-rpg-accent font-bold hover:text-white"><option value="">Classe</option></select>
                        <select id="char-subclass-select" onchange="updateSubclassFeatures()" class="bg-transparent outline-none cursor-pointer text-rpg-gold font-bold hover:text-white hidden"><option value="">Esp.</option></select>
                    </div>
                    <div class="flex items-center gap-2 border-b border-gray-700 px-1">
                        <select id="char-race-select" onchange="updateRaceFeatures()" class="bg-transparent outline-none cursor-pointer text-rpg-accent font-bold hover:text-white"><option value="">Ra√ßa</option></select>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="flex items-center gap-4 fantasy-panel p-3 px-6">
            <div class="text-center">
                <span class="block text-[10px] text-gray-500 uppercase font-bold tracking-widest font-header">N√≠vel</span>
                <input class="w-16 bg-transparent text-4xl font-bold text-white text-center outline-none border-none p-0 font-header" id="char-level" max="20" min="1" type="number" value="1" onchange="updateClassFeatures(); calculateAll()">
            </div>
            <div class="h-12 w-[1px] bg-gray-700"></div>
            <div class="text-center">
                <span class="block text-[10px] text-gray-500 uppercase font-bold tracking-widest font-header">Prof.</span>
                <span class="block text-4xl font-bold text-rpg-accent font-header" id="prof-bonus">+2</span>
            </div>
        </div>
    </header>

    <!-- NAVEGA√á√ÉO POR ABAS -->
    <nav class="max-w-7xl mx-auto mb-8 nav-tabs sticky top-0 z-40 bg-[#0c0a09]/95 backdrop-blur py-2 border-b border-gray-800">
        <button onclick="switchTab('status')" id="btn-status" class="tab-btn active"><span class="material-symbols-outlined text-lg">person</span> Geral</button>
        <button onclick="switchTab('combat')" id="btn-combat" class="tab-btn"><span class="material-symbols-outlined text-lg">swords</span> Combate</button>
        <button onclick="switchTab('spells')" id="btn-spells" class="tab-btn"><span class="material-symbols-outlined text-lg">auto_stories</span> Grim√≥rio</button>
        <button onclick="switchTab('equip')" id="btn-equip" class="tab-btn"><span class="material-symbols-outlined text-lg">backpack</span> Invent√°rio</button>
        <button onclick="switchTab('passives')" id="btn-passives" class="tab-btn"><span class="material-symbols-outlined text-lg">stars</span> Talentos</button>
    </nav>

    <main class="max-w-7xl mx-auto min-h-[600px] relative">
        
        <!-- ABA 1: STATUS -->
        <section id="tab-status" class="tab-content active">
            <div class="grid grid-cols-1 lg:grid-cols-12 gap-8">
                <!-- Atributos -->
                <div class="lg:col-span-3 space-y-3" id="attributes-container"></div>
                
                <div class="lg:col-span-9 flex flex-col gap-6">
                    <!-- Cards de Status -->
                    <div class="grid grid-cols-2 md:grid-cols-3 gap-4">
                        <div class="fantasy-panel p-4 flex flex-col items-center justify-center">
                            <span class="text-[10px] text-rpg-accent uppercase tracking-widest font-bold mb-1 font-header">Classe de Armadura</span>
                            <div class="flex items-end gap-1">
                                <span class="text-xs text-gray-500 mb-1">10 +</span>
                                <input class="w-12 bg-transparent text-4xl font-bold text-white text-center outline-none border-b border-gray-700 focus:border-rpg-accent font-header" id="ac-bonus-manual" type="number" value="0" oninput="calculateAll()">
                                <span class="text-xs text-rpg-gold ml-1 hidden animate-pulse font-header" id="ac-equip-bonus-display" title="B√¥nus de Equipamento">+0</span>
                            </div>
                            <span class="text-xs text-gray-500 mt-1">Total: <span id="ac-total-display" class="text-white font-bold text-lg">10</span></span>
                        </div>
                        <div class="fantasy-panel p-4 flex flex-col items-center justify-center">
                            <span class="text-[10px] text-rpg-accent uppercase tracking-widest font-bold mb-1 font-header">Iniciativa</span>
                            <span class="block text-4xl font-bold text-rpg-gold drop-shadow-md font-header" id="initiative-display">+0</span>
                            <span class="text-[9px] text-gray-500 mt-1">Destreza</span>
                        </div>
                        <div class="fantasy-panel p-4 flex flex-col items-center justify-center">
                            <span class="text-[10px] text-rpg-accent uppercase tracking-widest font-bold mb-1 font-header">Deslocamento</span>
                            <input class="w-full bg-transparent text-4xl font-bold text-white text-center outline-none font-header" id="char-speed" type="text" value="9m">
                        </div>
                    </div>

                    <!-- Barra de Vida -->
                    <div class="fantasy-panel p-6 flex flex-col md:flex-row items-center justify-between group border-l-4 border-l-rpg-red">
                        <div class="flex items-center gap-4 w-full md:w-auto mb-4 md:mb-0">
                            <div class="w-14 h-14 rounded-full bg-rpg-red/20 flex items-center justify-center text-rpg-red border border-rpg-red/50 shadow-[0_0_15px_rgba(153,27,27,0.4)]">
                                <span class="material-symbols-outlined text-3xl">favorite</span>
                            </div>
                            <div>
                                <span class="font-header text-2xl text-white block leading-none">Pontos de Vida</span>
                                <span class="text-[10px] text-gray-500 uppercase tracking-wider font-header">Vitalidade &amp; Sa√∫de</span>
                            </div>
                        </div>
                        <div class="flex gap-8 items-center">
                            <div class="text-center">
                                <input class="bg-black/40 text-4xl font-bold text-white text-center w-28 rounded border-b-2 border-rpg-red focus:border-white outline-none py-1 font-header" placeholder="--" type="number" value="">
                                <span class="text-[10px] uppercase text-gray-500 block mt-1 font-bold font-header">Atuais</span>
                            </div>
                            <span class="text-2xl text-gray-600">/</span>
                            <div class="text-center">
                                <input class="bg-black/40 text-4xl font-bold text-gray-400 text-center w-28 rounded border-b-2 border-gray-700 focus:border-white outline-none py-1 font-header" placeholder="--" type="number" value="">
                                <span class="text-[10px] uppercase text-gray-500 block mt-1 font-bold font-header">M√°ximo</span>
                            </div>
                        </div>
                    </div>

                    <!-- Lista de Per√≠cias -->
                    <div class="fantasy-panel p-6">
                        <div class="flex justify-between items-center mb-4 pb-2 border-b border-gray-800">
                            <h3 class="font-header text-xl text-rpg-accent flex items-center gap-2"><span class="material-symbols-outlined">psychology</span> Per√≠cias</h3>
                            <span id="skill-hint" class="text-[10px] text-rpg-gold border border-rpg-gold/30 px-2 py-1 rounded hidden animate-pulse font-header bg-rpg-gold/5">Recomendado para Classe</span>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-x-8 gap-y-1" id="skills-list"></div>
                    </div>
                </div>
            </div>
        </section>

        <!-- ABA 2: COMBATE -->
        <section id="tab-combat" class="tab-content hidden">
            <div class="fantasy-panel p-6 border-t-4 border-t-rpg-combat relative">
                <div class="absolute top-0 right-0 p-4 opacity-5 pointer-events-none"><span class="material-symbols-outlined text-9xl">swords</span></div>
                
                <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 relative z-10">
                    <div>
                        <h2 class="font-header text-3xl text-white flex items-center gap-3">Combate</h2>
                        <p class="text-xs text-gray-500 mt-1 uppercase tracking-wide font-header">Ataques, Armas &amp; Magias Ofensivas</p>
                    </div>
                    <div class="flex items-center gap-3 bg-black/40 p-2 rounded border border-gray-700 mt-4 md:mt-0">
                        <span class="material-symbols-outlined text-gray-500 text-sm">filter_vintage</span>
                        <div class="flex items-center gap-2 text-sm font-header">
                            <input class="w-12 bg-transparent text-center text-white font-bold border-b border-gray-600 focus:border-rpg-combat outline-none" placeholder="0" type="number">
                            <span class="text-gray-700">|</span>
                            <input class="w-12 bg-transparent text-center text-white font-bold border-b border-gray-600 focus:border-rpg-combat outline-none" placeholder="0" type="number">
                        </div>
                    </div>
                </div>
                
                <div id="global-combat-bonuses" class="hidden mb-6 p-3 bg-rpg-combat/10 border border-rpg-combat/30 rounded flex items-center gap-4 animate-up">
                    <span class="text-rpg-combat text-[10px] font-bold px-2 py-1 border border-rpg-combat rounded uppercase font-header">Equipamento Ativo</span>
                    <span class="text-xs text-gray-300 font-header" id="global-atk-display">+0 Ataque</span>
                    <span class="text-xs text-gray-300 font-header" id="global-dmg-display">+0 Dano</span>
                </div>

                <div class="overflow-x-auto custom-scrollbar pb-4">
                    <table class="w-full text-left border-collapse min-w-[900px]">
                        <thead class="text-[10px] uppercase text-gray-500 bg-black/40 tracking-wider font-header border-b border-gray-700">
                            <tr>
                                <th class="p-3 w-8"></th>
                                <th class="p-3 text-center w-12">√çcone</th>
                                <th class="p-3 text-center w-10">Prof</th>
                                <th class="p-3 w-48">Nome</th>
                                <th class="p-3 w-20">Attr</th>
                                <th class="p-3 w-16 text-center text-rpg-magic">M√°gico</th>
                                <th class="p-3 text-center w-24 text-rpg-accent">Acerto</th>
                                <th class="p-3 w-24">Dano Base</th>
                                <th class="p-3 text-left w-32 text-rpg-combat">Dano Total</th>
                                <th class="p-3 w-24">Tipo</th>
                                <th class="p-3 w-10"></th>
                            </tr>
                        </thead>
                        <tbody class="text-sm divide-y divide-gray-800" id="combat-rows"></tbody>
                        <tbody class="text-sm divide-y divide-gray-800 bg-rpg-magic/5" id="spell-combat-rows"></tbody>
                    </table>
                </div>
                <button class="w-full py-3 mt-4 border border-dashed border-gray-700 text-gray-500 hover:text-rpg-combat hover:border-rpg-combat hover:bg-rpg-combat/5 transition-colors rounded uppercase font-bold text-xs tracking-wider flex items-center justify-center gap-2 font-header" onclick="addCombatRow()">
                    <span class="material-symbols-outlined text-sm">add</span> Adicionar Arma Manual
                </button>
            </div>
        </section>

        <!-- ABA 3: GRIM√ìRIO -->
        <section id="tab-spells" class="tab-content hidden">
            <div class="fantasy-panel border-t-4 border-t-rpg-magic p-6 mb-8">
                <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-6">
                    <div>
                        <h2 class="font-header text-3xl text-white flex items-center gap-3">Grim√≥rio Arcano</h2>
                        <div class="flex items-center gap-4 mt-2">
                            <div class="flex flex-col">
                                <label class="text-[9px] text-rpg-magic uppercase font-bold mb-1 font-header">Atributo de Conjura√ß√£o</label>
                                <select class="bg-black/40 text-white font-bold border border-gray-700 rounded px-2 py-1 text-sm outline-none focus:border-rpg-magic font-header" id="spellcasting-ability" onchange="calculateAll()">
                                    <option value="int">Intelig√™ncia (Mago/Art√≠fice)</option>
                                    <option value="wis">Sabedoria (Cl√©rigo/Druida)</option>
                                    <option value="cha">Carisma (Bardo/Bruxo)</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    <div class="flex gap-4">
                        <div class="bg-black/40 p-3 rounded border border-gray-700 text-center min-w-[80px]">
                            <span class="block text-2xl font-bold text-white font-header" id="spell-save-dc">10</span>
                            <span class="text-[9px] text-rpg-magic uppercase font-bold font-header">CD Res</span>
                        </div>
                        <div class="bg-black/40 p-3 rounded border border-gray-700 text-center min-w-[80px]">
                            <span class="block text-2xl font-bold text-rpg-accent font-header" id="spell-attack-bonus">+2</span>
                            <span class="text-[9px] text-rpg-accent uppercase font-bold font-header">B√¥nus Atq</span>
                        </div>
                    </div>
                </div>
            </div>
            <div class="space-y-6" id="spell-levels-container"></div>
        </section>

        <!-- ABA 4: INVENT√ÅRIO -->
        <section id="tab-equip" class="tab-content hidden">
            <div class="grid grid-cols-1 xl:grid-cols-[1fr_500px] gap-8">
                <div class="fantasy-panel flex flex-col h-[800px]">
                    <div class="p-5 border-b border-gray-800 flex justify-between items-center bg-black/20">
                        <h3 class="font-header text-xl text-white flex items-center gap-2"><span class="material-symbols-outlined text-rpg-muted">backpack</span> Mochila</h3>
                        <div class="text-right">
                            <span class="block text-[9px] text-gray-500 uppercase font-bold font-header">Peso Total</span>
                            <span class="font-bold text-sm text-gray-300 font-header" id="weight-display">0.0 / <span id="max-weight">75</span> kg</span>
                        </div>
                    </div>
                    
                    <div class="flex-grow overflow-y-auto custom-scrollbar p-2">
                        <table class="w-full text-left text-sm border-collapse">
                            <thead class="text-[9px] uppercase text-gray-500 font-bold sticky top-0 bg-[#1c1917] z-10 shadow-sm font-header">
                                <tr>
                                    <th class="py-2 pl-3 w-10"></th>
                                    <th class="py-2 pl-2">Item</th>
                                    <th class="py-2 text-center w-14">Qtd</th>
                                    <th class="py-2 text-right w-16 pr-3">Kg</th>
                                    <th class="py-2 w-8"></th>
                                </tr>
                            </thead>
                            <tbody id="inventory-equipped-rows" class="bg-rpg-accent/5"></tbody>
                            <tbody id="inventory-rows" class="divide-y divide-gray-800/50"></tbody>
                        </table>
                        <button class="w-full py-3 mt-4 border border-dashed border-gray-700 text-gray-500 hover:text-white hover:border-gray-500 rounded transition-colors text-xs font-bold uppercase font-header" onclick="addInventoryRow()">+ Adicionar Item Manual</button>
                    </div>

                    <div class="p-4 border-t border-gray-800 bg-black/20 grid grid-cols-5 gap-2">
                        <div class="bg-black/40 p-2 rounded border border-gray-700 text-center"><label class="block text-[8px] text-[#bcaaa4] mb-1 font-bold font-header">PC</label><input class="w-full bg-transparent text-center text-white font-bold outline-none font-header" type="number" value="0"></div>
                        <div class="bg-black/40 p-2 rounded border border-gray-700 text-center"><label class="block text-[8px] text-[#cfd8dc] mb-1 font-bold font-header">PP</label><input class="w-full bg-transparent text-center text-white font-bold outline-none font-header" type="number" value="0"></div>
                        <div class="bg-black/40 p-2 rounded border border-gray-700 text-center"><label class="block text-[8px] text-[#ffd54f] mb-1 font-bold font-header">PE</label><input class="w-full bg-transparent text-center text-white font-bold outline-none font-header" type="number" value="0"></div>
                        <div class="bg-black/40 p-2 rounded border border-gray-700 text-center"><label class="block text-[8px] text-[#ffb74d] mb-1 font-bold font-header">PO</label><input class="w-full bg-transparent text-center text-white font-bold outline-none font-header" type="number" value="0"></div>
                        <div class="bg-black/40 p-2 rounded border border-gray-700 text-center"><label class="block text-[8px] text-[#e1bee7] mb-1 font-bold font-header">PL</label><input class="w-full bg-transparent text-center text-white font-bold outline-none font-header" type="number" value="0"></div>
                    </div>
                </div>

                <div class="fantasy-panel p-4 flex flex-col items-center relative h-[800px] overflow-y-auto custom-scrollbar">
                    <h3 class="font-header text-xl text-rpg-accent mb-4 absolute top-4 left-4 z-20">Equipamento <span class="text-xs text-gray-500 ml-2" id="attunement-display">(0/3)</span></h3>
                    <input type="hidden" id="attunement-max" value="3">
                    <div class="relative w-full h-[950px] mt-10 select-none scale-90 origin-top">
                        <!-- Silhueta SVG -->
                        <div class="absolute left-1/2 top-0 transform -translate-x-1/2 w-[400px] h-full opacity-10 pointer-events-none">
                            <svg viewBox="0 0 200 500" class="h-full w-auto text-white fill-current"><path d="M100 20 C120 20 135 35 135 55 C135 75 120 90 100 90 C80 90 65 75 65 55 C65 35 80 20 100 20 Z M40 110 L160 110 L150 250 L100 250 L50 250 L40 110 Z M50 260 L95 260 L90 450 L60 450 L50 260 Z M105 260 L150 260 L140 450 L110 450 L105 260 Z" /></svg>
                        </div>
                        <!-- Slots (Mantidos do script anterior) -->
                        <div class="equip-slot-container flex-col" style="top: 0%; left: 50%; transform: translateX(-50%);"><span class="slot-label">Cabe√ßa</span><div class="attunement-indicator" onclick="toggleAttune(this)"></div><input class="equip-input" data-slot="head" placeholder="Vazio" readonly onclick="openItemEditor(this)"></div>
                        <div class="equip-slot-container flex-row-reverse" style="top: 6%; left: 10%;"><input class="equip-input" data-slot="face" placeholder="Vazio" readonly onclick="openItemEditor(this)"><div class="attunement-indicator" onclick="toggleAttune(this)"></div><span class="slot-label" style="left:50%">Rosto</span></div>
                        <div class="equip-slot-container flex-row" style="top: 6%; right: 10%;"><div class="attunement-indicator" onclick="toggleAttune(this)"></div><input class="equip-input" data-slot="ears" placeholder="Vazio" readonly onclick="openItemEditor(this)"><span class="slot-label" style="left:50%">Orelhas</span></div>
                        <div class="equip-slot-container flex-col" style="top: 14%; left: 50%; transform: translateX(-50%); z-index:15;"><div class="attunement-indicator" onclick="toggleAttune(this)"></div><input class="equip-input" data-slot="neck" placeholder="Vazio" readonly onclick="openItemEditor(this)"></div>
                        <div class="equip-slot-container flex-row-reverse" style="top: 18%; left: 5%;"><input class="equip-input" data-slot="back" placeholder="Vazio" readonly onclick="openItemEditor(this)"><div class="attunement-indicator" onclick="toggleAttune(this)"></div><span class="slot-label" style="left:50%">Costas</span></div>
                        <div class="equip-slot-container flex-row" style="top: 25%; right: 5%;"><div class="attunement-indicator" onclick="toggleAttune(this)"></div><input class="equip-input" data-slot="body_skin" placeholder="Vazio" readonly onclick="openItemEditor(this)"><span class="slot-label" style="left:50%">Corpo</span></div>
                        <div class="equip-slot-container flex-col" style="top: 28%; left: 50%; transform: translateX(-50%); z-index:20;"><span class="slot-label text-rpg-gold font-bold">Torso (Armadura)</span><div class="attunement-indicator" onclick="toggleAttune(this)"></div><input class="equip-input border-rpg-gold/50 text-rpg-accent font-bold" data-slot="torso" placeholder="Armadura" readonly onclick="openItemEditor(this)"></div>
                        <div class="equip-slot-container flex-row-reverse" style="top: 38%; left: 2%;"><input class="equip-input" data-slot="wrist_l" placeholder="Vazio" readonly onclick="openItemEditor(this)"><div class="attunement-indicator" onclick="toggleAttune(this)"></div><span class="slot-label" style="left:50%">Pulso</span></div>
                        <div class="equip-slot-container flex-row" style="top: 38%; right: 2%;"><div class="attunement-indicator" onclick="toggleAttune(this)"></div><input class="equip-input" data-slot="wrist_r" placeholder="Vazio" readonly onclick="openItemEditor(this)"><span class="slot-label" style="left:50%">Pulso</span></div>
                        <div class="equip-slot-container flex-col" style="top: 40%; left: 50%; transform: translateX(-50%);"><input class="equip-input" data-slot="hands" placeholder="Vazio" readonly onclick="openItemEditor(this)"><span class="slot-label" style="top: 35px">M√£os</span></div>
                        <div class="equip-slot-container flex-col" style="top: 48%; left: 50%; transform: translateX(-50%);"><span class="slot-label">Cintura</span><div class="attunement-indicator" onclick="toggleAttune(this)"></div><input class="equip-input" data-slot="waist" placeholder="Cinto" readonly onclick="openItemEditor(this)"></div>
                        <div class="equip-slot-container flex-row-reverse" style="top: 55%; left: 0%;"><input class="equip-input h-10 border-rpg-accent font-bold" data-slot="hand_l" placeholder="M√£o Esquerda" readonly onclick="openItemEditor(this)"><div class="attunement-indicator" onclick="toggleAttune(this)"></div><span class="slot-label text-rpg-accent font-bold" style="left:50%">M√£o Esq.</span></div>
                        <div class="equip-slot-container flex-row" style="top: 55%; right: 0%;"><div class="attunement-indicator" onclick="toggleAttune(this)"></div><input class="equip-input h-10 border-rpg-accent font-bold" data-slot="hand_r" placeholder="M√£o Direita" readonly onclick="openItemEditor(this)"><span class="slot-label text-rpg-accent font-bold" style="left:50%">M√£o Dir.</span></div>
                        <div class="equip-slot-container flex-row-reverse" style="top: 65%; left: 8%;"><input class="equip-input" data-slot="finger_l" placeholder="Vazio" readonly onclick="openItemEditor(this)"><div class="attunement-indicator" onclick="toggleAttune(this)"></div></div>
                        <div class="equip-slot-container flex-row" style="top: 65%; right: 8%;"><div class="attunement-indicator" onclick="toggleAttune(this)"></div><input class="equip-input" data-slot="finger_r" placeholder="Vazio" readonly onclick="openItemEditor(this)"></div>
                        <div class="equip-slot-container flex-col" style="top: 90%; left: 50%; transform: translateX(-50%);"><span class="slot-label">P√©s</span><div class="attunement-indicator" onclick="toggleAttune(this)"></div><input class="equip-input" data-slot="feet" placeholder="Vazio" readonly onclick="openItemEditor(this)"></div>
                    </div>
                </div>
            </div>
        </section>

        <!-- ABA 5: PASSIVAS -->
        <section id="tab-passives" class="tab-content hidden">
            <div class="flex justify-between items-center mb-6">
                <h2 class="font-header text-2xl text-white">Talentos &amp; Caracter√≠sticas</h2>
                <button class="bg-white/10 hover:bg-white/20 text-white px-4 py-2 rounded border border-gray-700 font-bold text-xs uppercase tracking-widest transition-colors flex items-center gap-2 font-header" onclick="addPassive()">
                    <span class="material-symbols-outlined text-sm">add</span> Adicionar Novo
                </button>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6" id="passives-grid"></div>
        </section>

    </main>

<script>
    // --- FUN√á√ÉO DE ABAS CORRIGIDA ---
    function switchTab(tabId) {
        document.querySelectorAll('.tab-content').forEach(el => {
            el.classList.remove('active');
            el.style.display = 'none';
        });
        document.querySelectorAll('.tab-btn').forEach(el => {
            el.classList.remove('active');
        });
        const activeTab = document.getElementById('tab-' + tabId);
        if(activeTab) {
            activeTab.classList.add('active');
            activeTab.style.display = 'block';
        }
        const activeBtn = document.getElementById('btn-' + tabId);
        if(activeBtn) {
            activeBtn.classList.add('active');
        }
    }

    // --- L√ìGICA DO SISTEMA ---
    const attributes = [{id:'str',abbr:'FOR'},{id:'dex',abbr:'DES'},{id:'con',abbr:'CON'},{id:'int',abbr:'INT'},{id:'wis',abbr:'SAB'},{id:'cha',abbr:'CAR'}];
    const skills = [{name:'Acrobacia',attr:'dex'},{name:'Arcanismo',attr:'int'},{name:'Atletismo',attr:'str'},{name:'Atua√ß√£o',attr:'cha'},{name:'Engana√ß√£o',attr:'cha'},{name:'Furtividade',attr:'dex'},{name:'Hist√≥ria',attr:'int'},{name:'Intimida√ß√£o',attr:'cha'},{name:'Intui√ß√£o',attr:'wis'},{name:'Investiga√ß√£o',attr:'int'},{name:'Lidar com Animais',attr:'wis'},{name:'Medicina',attr:'wis'},{name:'Natureza',attr:'int'},{name:'Percep√ß√£o',attr:'wis'},{name:'Persuas√£o',attr:'cha'},{name:'Prestidigita√ß√£o',attr:'dex'},{name:'Religi√£o',attr:'int'},{name:'Sobreviv√™ncia',attr:'wis'}];
    const damageTypes = [{val:'fire',label:'Fogo',icon:'local_fire_department',color:'text-red-500'}, {val:'cold',label:'Frio',icon:'ac_unit',color:'text-cyan-400'}, {val:'lightning',label:'El√©trico',icon:'flash_on',color:'text-yellow-400'}, {val:'necrotic',label:'Necr√≥tico',icon:'skull',color:'text-green-600'}, {val:'radiant',label:'Radiante',icon:'sunny',color:'text-yellow-200'}, {val:'acid',label:'√Åcido',icon:'science',color:'text-green-500'}, {val:'poison',label:'Veneno',icon:'coronavirus',color:'text-green-700'}, {val:'psychic',label:'Ps√≠quico',icon:'psychology',color:'text-pink-500'}, {val:'force',label:'Energia',icon:'lens_blur',color:'text-purple-400'}, {val:'thunder',label:'Trov√£o',icon:'surround_sound',color:'text-blue-400'}, {val:'heal',label:'Cura',icon:'favorite',color:'text-red-400'}, {val:'slashing',label:'Cortante',icon:'content_cut',color:'text-gray-400'}, {val:'piercing',label:'Perfurante',icon:'gps_fixed',color:'text-gray-400'}, {val:'bludgeoning',label:'Contundente',icon:'hammer',color:'text-gray-400'}, {val:'utility',label:'Utilidade',icon:'auto_fix_high',color:'text-gray-400'}];
    const passiveTypes = [{id:'combat',label:'Combate',icon:'swords',color:'bg-rpg-combat',border:'border-rpg-combat', textColor:'text-rpg-combat'}, {id:'utility',label:'Utilidade',icon:'visibility',color:'bg-rpg-utility',border:'border-rpg-utility', textColor:'text-rpg-utility'}, {id:'magic',label:'Magia',icon:'auto_fix_high',color:'bg-rpg-magic',border:'border-rpg-magic', textColor:'text-rpg-magic'}, {id:'alchemy',label:'Alquimia',icon:'science',color:'bg-rpg-alchemy',border:'border-rpg-alchemy', textColor:'text-rpg-alchemy'}, {id:'tech',label:'Tecnologia',icon:'precision_manufacturing',color:'bg-rpg-tech',border:'border-rpg-tech', textColor:'text-rpg-tech'}, {id:'social',label:'Social',icon:'groups',color:'bg-rpg-social',border:'border-rpg-social', textColor:'text-rpg-social'}];
    let defaultSlots = [4, 4, 4, 4, 3, 3, 3, 2, 2];
    let equipmentData = {};
    let inventoryData = {}; 

    // Incluir SRD_LIB 
    const SRD_LIB = {
        classes: {
            "B√°rbaro": { hitDie: 12, skills: ['str', 'con'], skillOpts: [2, 11, 12, 13, 17], saves: ['str', 'con'], slots: null, subclassLevel: 3, features: [{name: "F√∫ria", desc: "Vantagem em testes de For√ßa. Dano extra. Resist√™ncia a concuss√£o, cortante e perfurante."}, {name: "Defesa sem Armadura", desc: "CA = 10 + Des + Con."}] },
            "Bardo": { hitDie: 8, skills: ['dex', 'cha'], skillOpts: 'any', saves: ['dex', 'cha'], slots: "full", subclassLevel: 3, features: [{name: "Inspira√ß√£o de Bardo", desc: "A√ß√£o b√¥nus: conceda um d6 a um aliado."}, {name: "Conjura√ß√£o", desc: "Voc√™ conhece truques e magias."}] },
            "Cl√©rigo": { hitDie: 8, skills: ['wis', 'cha'], skillOpts: [6, 8, 11, 14, 16], saves: ['wis', 'cha'], slots: "full", subclassLevel: 1, features: [{name: "Conjura√ß√£o", desc: "Prepara magias divinas."}, {name: "Canalizar Divindade", desc: "Efeito m√°gico divino."}] },
            "Druida": { hitDie: 8, skills: ['wis', 'int'], skillOpts: [1, 2, 8, 11, 12, 16, 17], saves: ['int', 'wis'], slots: "full", subclassLevel: 2, features: [{name: "Dru√≠dico", desc: "Linguagem secreta."}, {name: "Conjura√ß√£o", desc: "Magias naturais."}] },
            "Guerreiro": { hitDie: 10, skills: ['str', 'con'], skillOpts: [0, 2, 6, 9, 13, 17], saves: ['str', 'con'], slots: null, subclassLevel: 3, features: [{name: "Estilo de Luta", desc: "Escolha uma especializa√ß√£o."}, {name: "Retomar o F√¥lego", desc: "Cura 1d10+N√≠vel (B√¥nus)."}] },
            "Ladino": { hitDie: 8, skills: ['dex', 'int'], skillOpts: [0, 2, 4, 5, 8, 9, 13, 14, 15], saves: ['dex', 'int'], slots: null, subclassLevel: 3, features: [{name: "Ataque Furtivo", desc: "Dano extra com vantagem/aliado."}, {name: "G√≠ria", desc: "Linguagem secreta."}] },
            "Mago": { hitDie: 6, skills: ['int', 'wis'], skillOpts: [1, 6, 8, 9, 11, 16], saves: ['int', 'wis'], slots: "full", subclassLevel: 2, features: [{name: "Conjura√ß√£o", desc: "Usa grim√≥rio."}, {name: "Recupera√ß√£o Arcana", desc: "Recupera slots no descanso curto."}] },
            "Monge": { hitDie: 8, skills: ['dex', 'wis'], skillOpts: [0, 2, 6, 8, 16, 5], saves: ['str', 'dex'], slots: null, subclassLevel: 3, features: [{name: "Defesa sem Armadura", desc: "CA = 10 + Des + Sab."}, {name: "Artes Marciais", desc: "Ataque Desarmado (Des, d4)."}] },
            "Paladino": { hitDie: 10, skills: ['str', 'cha'], skillOpts: [2, 8, 11, 13, 14, 16], saves: ['wis', 'cha'], slots: "half", subclassLevel: 3, features: [{name: "Sentido Divino", desc: "Detecta extraplanares."}, {name: "Cura pelas M√£os", desc: "Cura N√≠vel x 5."}] },
            "Patrulheiro": { hitDie: 10, skills: ['dex', 'wis'], skillOpts: [2, 5, 8, 9, 10, 11, 12, 17], saves: ['str', 'dex'], slots: "half", subclassLevel: 3, features: [{name: "Inimigo Favorito", desc: "Vantagem rastreio."}, {name: "Explorador Natural", desc: "Vantagem terreno."}] },
            "Feiticeiro": { hitDie: 6, skills: ['cha', 'con'], skillOpts: [1, 4, 8, 13, 14, 16], saves: ['con', 'cha'], slots: "full", subclassLevel: 1, features: [{name: "Conjura√ß√£o", desc: "Magia inata."}, {name: "Origem", desc: "Subclasse N√≠vel 1."}] },
            "Bruxo": { hitDie: 8, skills: ['cha', 'wis'], skillOpts: [1, 4, 6, 7, 9, 12, 16], saves: ['wis', 'cha'], slots: "pact", subclassLevel: 1, features: [{name: "Patrono", desc: "Subclasse N√≠vel 1."}, {name: "Magia de Pacto", desc: "Slots recarregam no curto."}] },
            "Art√≠fice": { hitDie: 8, skills: ['int', 'con'], skillOpts: [1, 6, 8, 9, 11, 12, 15], saves: ['con', 'int'], slots: "half", subclassLevel: 3, features: [{name: "Engenhosidade", desc: "Ferramentas."}, {name: "Conjura√ß√£o", desc: "Prepara magias."}] }
        },
        subclasses: {
            "B√°rbaro": { "Berserker": {features: [{name: "Frenesi", desc: "Ataque extra como a√ß√£o b√¥nus (gera exaust√£o)."}]}, "Totem": {features: [{name: "Esp√≠rito Tot√™mico", desc: "Escolha um animal totem."}]} },
            "Bardo": { "Conhecimento": {features: [{name: "Palavras Cortantes", desc: "Reduz ataque/dano inimigo."}]}, "Bravura": {features: [{name: "Inspira√ß√£o de Combate", desc: "Soma ao dano ou CA."}]} },
            "Cl√©rigo": { "Vida": {features: [{name: "Disc√≠pulo da Vida", desc: "Cura extra 2+N√≠vel."}]}, "Guerra": {features: [{name: "Sacerdote de Guerra", desc: "Ataque extra b√¥nus."}]} },
            "Druida": { "Terra": {features: [{name: "Recupera√ß√£o Natural", desc: "Recupera slots."}]}, "Lua": {features: [{name: "Forma de Combate", desc: "Vira fera CR 1 a√ß√£o b√¥nus."}]} },
            "Guerreiro": { "Campe√£o": {features: [{name: "Cr√≠tico Aprimorado", desc: "Cr√≠tico 19-20."}]}, "Mestre de Batalha": {features: [{name: "Manobras", desc: "Dados de superioridade."}]} },
            "Ladino": { "Ladr√£o": {features: [{name: "M√£os R√°pidas", desc: "Uso de item b√¥nus."}]}, "Assassino": {features: [{name: "Assassinato", desc: "Cr√≠tico em surpresa."}]} },
            "Mago": { "Evoca√ß√£o": {features: [{name: "Esculpir Magias", desc: "Protege aliados de √°rea."}]}, "Necromancia": {features: [{name: "Ceifador", desc: "Cura ao matar."}]} },
            "Monge": { "M√£o Aberta": {features: [{name: "T√©cnica M√£o Aberta", desc: "Derruba ou empurra."}]}, "Sombras": {features: [{name: "Artes das Sombras", desc: "Magias de furtividade."}]} },
            "Paladino": { "Devo√ß√£o": {features: [{name: "Arma Sagrada", desc: "Soma Car no ataque."}]}, "Vingan√ßa": {features: [{name: "Inimizade", desc: "Vantagem contra um alvo."}]} },
            "Patrulheiro": { "Ca√ßador": {features: [{name: "Matador de Colossos", desc: "1d8 extra."}]}, "Mestre das Feras": {features: [{name: "Companheiro", desc: "Animal aliado."}]} },
            "Feiticeiro": { "Drac√¥nica": {features: [{name: "Resili√™ncia", desc: "CA 13+Des."}]}, "Selvagem": {features: [{name: "Surto", desc: "Efeito aleat√≥rio."}]} },
            "Bruxo": { "Corruptor": {features: [{name: "B√™n√ß√£o", desc: "PV tempor√°rio ao matar."}]}, "Arquifada": {features: [{name: "Presen√ßa", desc: "Amedronta/Encanta."}]} },
            "Art√≠fice": { "Alquimista": {features: [{name: "Elixir", desc: "Po√ß√µes aleat√≥rias."}]}, "Armeiro": {features: [{name: "Armadura Arcana", desc: "Arma integrada."}]}, "Artilheiro": {features: [{name: "Canh√£o", desc: "Torreta m√°gica."}]}, "Ferreiro": {features: [{name: "Defensor de A√ßo", desc: "Constructo."}]} }
        },
        races: { 
            "Humano": { speed: "9m", traits: [{name: "Vers√°til", desc: "+1 todos atributos."}] },
            "An√£o": { speed: "7.5m", traits: [{name: "Vis√£o no Escuro", desc: "18m."}, {name: "Resili√™ncia", desc: "Resist√™ncia Veneno."}] },
            "Elfo": { speed: "9m", traits: [{name: "Vis√£o no Escuro", desc: "18m."}, {name: "Sentidos", desc: "Percep√ß√£o."}, {name: "Transe", desc: "4h descanso."}] },
            "Halfling": { speed: "7.5m", traits: [{name: "Sortudo", desc: "Rerola 1."}, {name: "Bravura", desc: "Vantagem medo."}] },
            "Draconato": { speed: "9m", traits: [{name: "Sopro", desc: "Dano em √°rea."}, {name: "Resist√™ncia", desc: "Elemento ancestral."}] },
            "Gnomo": { speed: "7.5m", traits: [{name: "Vis√£o no Escuro", desc: "18m."}, {name: "Ast√∫cia", desc: "Vantagem mental vs magia."}] },
            "Meio-Elfo": { speed: "9m", traits: [{name: "Vis√£o no Escuro", desc: "18m."}, {name: "Versatilidade", desc: "2 per√≠cias."}] },
            "Meio-Orc": { speed: "9m", traits: [{name: "Vis√£o no Escuro", desc: "18m."}, {name: "Implac√°vel", desc: "Cai a 1 PV (1/descanso)."}] },
            "Tiefling": { speed: "9m", traits: [{name: "Vis√£o no Escuro", desc: "18m."}, {name: "Resist√™ncia", desc: "Fogo."}] }
        },
        items: [{name: "Adaga", weight: 0.5, desc: "Acuidade, Leve.", damage: "1d4 Perfurante", ac: 0, atk: 0, dmg: 0, dc: 0}, {name: "Espada Curta", weight: 1, desc: "Acuidade, Leve.", damage: "1d6 Perfurante", ac: 0, atk: 0, dmg: 0, dc: 0}, {name: "Espada Longa", weight: 1.5, desc: "Vers√°til (1d10).", damage: "1d8 Cortante", ac: 0, atk: 0, dmg: 0, dc: 0}, {name: "Machado Grande", weight: 3.5, desc: "Pesada, Duas M√£os.", damage: "1d12 Cortante", ac: 0, atk: 0, dmg: 0, dc: 0}, {name: "Po√ß√£o Cura", weight: 0.5, desc: "2d4+2 PV.", damage: "Cura 2d4+2", ac: 0, atk: 0, dmg: 0, dc: 0}, {name: "Espada +1", weight: 1.5, desc: "Espada m√°gica.", damage: "1d8+1 Cortante", ac: 0, atk: 1, dmg: 1, dc: 0}, {name: "Escudo +1", weight: 3, desc: "Escudo m√°gico.", damage: "", ac: 3, atk: 0, dmg: 0, dc: 0}],
        spells: [{name: "M√£os M√°gicas", level: 0, desc: "M√£o espectral (9m).", type: "force"}, {name: "Raio de Fogo", level: 0, desc: "1d10 fogo.", type: "fire"}, {name: "M√≠sseis M√°gicos", level: 1, desc: "3x 1d4+1 auto.", type: "force"}, {name: "Curar Ferimentos", level: 1, desc: "1d8+Mod.", type: "heal"}, {name: "Bola de Fogo", level: 3, desc: "8d6 fogo √°rea.", type: "fire"}],
        slots: {
            full: [[2,0,0,0,0,0,0,0,0], [3,0,0,0,0,0,0,0,0], [4,2,0,0,0,0,0,0,0], [4,3,0,0,0,0,0,0,0], [4,3,2,0,0,0,0,0,0], [4,3,3,0,0,0,0,0,0], [4,3,3,1,0,0,0,0,0], [4,3,3,2,0,0,0,0,0], [4,3,3,3,1,0,0,0,0], [4,3,3,3,2,0,0,0,0], [4,3,3,3,2,1,0,0,0], [4,3,3,3,2,1,0,0,0], [4,3,3,3,2,1,1,0,0], [4,3,3,3,2,1,1,0,0], [4,3,3,3,2,1,1,1,0], [4,3,3,3,2,1,1,1,0], [4,3,3,3,2,1,1,1,1], [4,3,3,3,3,1,1,1,1], [4,3,3,3,3,2,1,1,1], [4,3,3,3,3,2,2,1,1]],
            half: [[0,0,0,0,0,0,0,0,0], [2,0,0,0,0,0,0,0,0], [3,0,0,0,0,0,0,0,0], [3,0,0,0,0,0,0,0,0], [4,2,0,0,0,0,0,0,0], [4,2,0,0,0,0,0,0,0], [4,3,0,0,0,0,0,0,0], [4,3,0,0,0,0,0,0,0], [4,3,2,0,0,0,0,0,0], [4,3,2,0,0,0,0,0,0], [4,3,3,0,0,0,0,0,0], [4,3,3,0,0,0,0,0,0], [4,3,3,1,0,0,0,0,0], [4,3,3,1,0,0,0,0,0], [4,3,3,2,0,0,0,0,0], [4,3,3,2,0,0,0,0,0], [4,3,3,3,1,0,0,0,0], [4,3,3,3,1,0,0,0,0], [4,3,3,3,2,0,0,0,0], [4,3,3,3,2,0,0,0,0]],
            pact: [[1,0,0,0,0,0,0,0,0], [2,0,0,0,0,0,0,0,0], [0,2,0,0,0,0,0,0,0], [0,2,0,0,0,0,0,0,0], [0,0,2,0,0,0,0,0,0], [0,0,2,0,0,0,0,0,0], [0,0,0,2,0,0,0,0,0], [0,0,0,2,0,0,0,0,0], [0,0,0,0,2,0,0,0,0], [0,0,0,0,2,0,0,0,0], [0,0,0,0,3,0,0,0,0], [0,0,0,0,3,0,0,0,0], [0,0,0,0,3,0,0,0,0], [0,0,0,0,3,0,0,0,0], [0,0,0,0,3,0,0,0,0], [0,0,0,0,3,0,0,0,0], [0,0,0,0,4,0,0,0,0], [0,0,0,0,4,0,0,0,0], [0,0,0,0,4,0,0,0,0], [0,0,0,0,4,0,0,0,0]]
        }
    };

    // 2. FUN√á√ïES DE SETUP (HOISTED)
    function populateSelects() {
        const classSel = document.getElementById('char-class-select'); const raceSel = document.getElementById('char-race-select');
        classSel.innerHTML = '<option value="">Classe</option>';
        raceSel.innerHTML = '<option value="">Ra√ßa</option>';
        Object.keys(SRD_LIB.classes).forEach(c => { const opt = document.createElement('option'); opt.value = c; opt.textContent = c; classSel.appendChild(opt); });
        classSel.appendChild(new Option("Personalizado", "custom"));
        Object.keys(SRD_LIB.races).forEach(r => { const opt = document.createElement('option'); opt.value = r; opt.textContent = r; raceSel.appendChild(opt); });
        raceSel.appendChild(new Option("Personalizado", "custom"));
    }
    function populateItemLib() {
        const sel = document.getElementById('item-library-select');
        sel.innerHTML = '<option value="">-- Importar Item Padr√£o --</option>';
        SRD_LIB.items.forEach((item, idx) => { const opt = document.createElement('option'); opt.value = idx; opt.textContent = item.name + (item.ac ? ` (CA ${item.ac})` : '') + (item.damage ? ` (${item.damage})` : ''); sel.appendChild(opt); });
    }
    function renderAttributes() { document.getElementById('attributes-container').innerHTML = attributes.map(a => `<div class="fantasy-panel p-2 flex items-center justify-between"><div class="text-center w-12"><span class="text-[9px] font-bold text-gray-500 block uppercase font-header">${a.abbr}</span><input type="number" id="score-${a.id}" value="10" class="w-full bg-transparent text-white font-bold text-lg text-center outline-none border-b border-transparent focus:border-rpg-accent font-header" oninput="calculateAll()"></div><span id="mod-${a.id}" class="text-2xl font-bold text-rpg-accent font-header">+0</span><div class="border-l border-gray-700 pl-2 text-center"><span class="text-[8px] text-gray-500 block uppercase font-header">Salva</span><div class="flex items-center gap-1"><input type="checkbox" id="save-${a.id}" class="accent-rpg-accent w-3 h-3 cursor-pointer" onchange="calculateAll()"><span id="save-val-${a.id}" class="text-xs font-bold text-gray-400 font-header">+0</span></div></div></div>`).join(''); }
    function renderSkills() { document.getElementById('skills-list').innerHTML = skills.map((s, i) => `<div class="flex items-center justify-between py-1 px-2 hover:bg-white/5 rounded transition-colors group skill-row" id="skill-row-${i}"><div class="flex items-center gap-2"><input type="checkbox" id="skill-${i}" data-attr="${s.attr}" class="accent-rpg-accent w-3 h-3 cursor-pointer" onclick="calculateAll(); checkSkillHighlight(this)"><span class="text-sm text-gray-400 group-hover:text-white transition-colors">${s.name} <span class="text-[9px] text-gray-600 uppercase ml-1">${s.attr}</span></span></div><span id="skill-val-${i}" class="text-sm font-bold text-gray-500 group-hover:text-rpg-accent transition-colors">+0</span></div>`).join(''); }
    function renderInventory(n) { for(let i=0; i<n; i++) addInventoryRow(); }
    
    // --- FUN√á√ïES DE L√ìGICA ---
    function updateClassFeatures() {
        const className = document.getElementById('char-class-select').value;
        const level = parseInt(document.getElementById('char-level').value) || 1;
        const hint = document.getElementById('skill-hint');
        const subclassContainer = document.getElementById('subclass-container');
        
        document.querySelectorAll('.skill-row').forEach(row => row.classList.remove('suggestion-ring'));
        if(hint) hint.classList.add('hidden');
        document.querySelectorAll('.glass-panel[data-origin="class"]').forEach(el => el.remove());
        document.querySelectorAll('.glass-panel[data-origin="subclass"]').forEach(el => el.remove());

        if (className && SRD_LIB.classes[className]) {
            const data = SRD_LIB.classes[className];
            if(data.features) data.features.forEach(feat => addPassiveCard(feat.name, feat.desc, 0, "class"));
            
            if (data.skillOpts && data.skillOpts !== 'any') {
                if(hint) hint.classList.remove('hidden');
                data.skillOpts.forEach(idx => {
                    const row = document.getElementById(`skill-row-${idx}`);
                    if(row && !row.querySelector('input').checked) row.classList.add('suggestion-ring');
                });
            }

            // Subclasse L√≥gica
            if (level >= (data.subclassLevel || 3) && SRD_LIB.subclasses[className]) {
                const sel = document.getElementById('char-subclass-select');
                if(sel) {
                    sel.classList.remove('hidden'); // Show subclass select
                    if(sel.dataset.currentClass !== className) {
                        sel.innerHTML = '<option value="">-- Selecione --</option>';
                        Object.keys(SRD_LIB.subclasses[className]).forEach( sub => {
                            sel.appendChild(new Option(sub, sub));
                        });
                        sel.dataset.currentClass = className;
                    }
                }
            } else {
                const sel = document.getElementById('char-subclass-select');
                if(sel) sel.classList.add('hidden');
            }
        }
        calculateAll();
    }
    
    function updateSubclassFeatures() {
        const className = document.getElementById('char-class-select').value;
        const subName = document.getElementById('char-subclass-select').value;
        document.querySelectorAll('.glass-panel[data-origin="subclass"]').forEach(el => el.remove());

        if(className && subName && SRD_LIB.subclasses[className][subName]) {
            const features = SRD_LIB.subclasses[className][subName].features;
            features.forEach(feat => addPassiveCard(feat.name, feat.desc, 2, "subclass"));
        }
    }

    function updateRaceFeatures() {
        const raceName = document.getElementById('char-race-select').value;
        document.querySelectorAll('.glass-panel[data-origin="race"]').forEach(el => el.remove());
        if (raceName && SRD_LIB.races[raceName]) {
            const data = SRD_LIB.races[raceName];
            document.getElementById('char-speed').value = data.speed;
            if(data.traits) data.traits.forEach(trait => addPassiveCard(trait.name, trait.desc, 5, "race"));
        }
    }

    function checkSkillHighlight(checkbox) { if(checkbox.checked) checkbox.closest('.skill-row').classList.remove('suggestion-ring'); }
    function addPassiveCard(t,d,i, origin) { 
        const div = document.createElement('div'); const type = passiveTypes[i]||passiveTypes[0]; 
        let originClass = "", originText = "";
        if(origin === "race") { originClass = "border-green-500 text-green-400"; originText = "Ra√ßa"; }
        if(origin === "class") { originClass = "border-blue-500 text-blue-400"; originText = "Classe"; }
        if(origin === "subclass") { originClass = "border-yellow-500 text-yellow-400"; originText = "Subclasse"; }

        div.className = `fantasy-panel p-3 h-full flex flex-col min-h-[160px]`;
        if(origin) div.setAttribute('data-origin', origin);
        
        let headerHtml = `<div class="flex items-center justify-between mb-2"><div class="flex items-center gap-2 flex-grow"><button onclick="cyclePassiveType(this)" class="w-6 h-6 rounded-full ${type.color} flex items-center justify-center text-black font-bold transition-colors shrink-0" data-idx="${i}"><span class="material-symbols-outlined text-sm">${type.icon}</span></button>`;
        if(originText) headerHtml += `<span class="text-[9px] uppercase px-1 rounded border ${originClass} font-header">${originText}</span>`;
        headerHtml += `<span class="passive-badge bg-black/50 border border-gray-700 ${type.textColor}">${type.label}</span></div><button onclick="this.closest('.fantasy-panel').remove()" class="text-gray-600 hover:text-rpg-red opacity-0 group-hover:opacity-100"><span class="material-symbols-outlined text-sm">close</span></button></div>`;

        div.innerHTML = `${headerHtml}<input class="bg-transparent font-bold text-white w-full outline-none border-b border-transparent focus:border-rpg-muted mb-1 font-header" value="${t}" placeholder="Nome"><textarea class="bg-transparent w-full text-sm text-gray-300 resize-none h-20 outline-none custom-scrollbar flex-grow font-body" placeholder="Descri√ß√£o...">${d}</textarea>`; 
        document.getElementById('passives-grid').appendChild(div); 
    }
    
    function addPassive() { addPassiveCard('','',0); }
    function cyclePassiveType(btn) { let idx=(parseInt(btn.dataset.idx)+1)%passiveTypes.length; btn.dataset.idx=idx; const t=passiveTypes[idx]; const c=btn.closest('.fantasy-panel'); btn.className=`w-6 h-6 rounded-full ${t.color} flex items-center justify-center text-black font-bold transition-colors shrink-0`; btn.querySelector('span').textContent=t.icon; const badge = c.querySelector('.passive-badge'); badge.className = `passive-badge bg-black/50 border border-gray-700 ${t.textColor}`; badge.textContent = t.label; }
    
    // API SEARCH
    async function searchSpellApi() {
        const query = document.getElementById('api-spell-search').value;
        const resultsDiv = document.getElementById('api-search-results');
        if(!query) return;
        resultsDiv.innerHTML = '<div class="text-center p-2"><div class="loader"></div></div>';
        resultsDiv.classList.remove('hidden');
        try {
            const response = await fetch(`https://www.dnd5eapi.co/api/spells/?name=${query}`);
            const data = await response.json();
            if(data.count === 0) { resultsDiv.innerHTML = '<div class="text-xs text-red-400 p-2">Nenhuma magia encontrada. Tente o nome em ingl√™s.</div>'; return; }
            resultsDiv.innerHTML = '';
            data.results.forEach(spell => {
                const btn = document.createElement('button');
                btn.className = "w-full text-left text-xs bg-white/5 hover:bg-rpg-magic/20 p-2 rounded text-white border border-transparent hover:border-rpg-magic transition-colors font-body";
                btn.textContent = spell.name;
                btn.onclick = () => fetchSpellDetails(spell.url);
                resultsDiv.appendChild(btn);
            });
        } catch (e) { resultsDiv.innerHTML = '<div class="text-xs text-red-400 p-2">Erro ao conectar na API.</div>'; }
    }

    async function fetchSpellDetails(url) {
        const resultsDiv = document.getElementById('api-search-results');
        resultsDiv.innerHTML = '<div class="text-center p-2"><div class="loader"></div></div>';
        try {
            const response = await fetch(`https://www.dnd5eapi.co${url}`);
            const data = await response.json();
            const level = data.level || 0;
            const name = data.name;
            const desc = data.desc.join('\n\n');
            let type = "utility";
            if(data.school.index === 'evocation') type = 'fire';
            if(data.school.index === 'necromancy') type = 'necrotic';
            if(data.school.index === 'restoration') type = 'heal';
            createSpellCardElement(level, name, desc, "", type, "", "", "", "", "");
            resultsDiv.classList.add('hidden');
            closeSpellModal();
        } catch (e) { resultsDiv.innerHTML = '<div class="text-xs text-red-400 p-2">Erro nos detalhes da magia.</div>'; }
    }

    function initSpellbook() { const c = document.getElementById('spell-levels-container'); if(c.children.length > 0) return; c.innerHTML += createSpellLevelSection(0, Infinity); for(let i=1; i<=9; i++) c.innerHTML += createSpellLevelSection(i, defaultSlots[i-1]); }
    function createSpellLevelSection(level, slots) { const title = level === 0 ? "Truques (N√≠vel 0)" : `C√≠rculo ${level}`; return `<div class="bg-black/20 border border-gray-800 rounded-xl overflow-hidden" id="spell-group-${level}"><div class="flex justify-between items-center p-3 bg-white/5 cursor-pointer hover:bg-white/10 transition-colors" onclick="this.parentElement.querySelector('.collapsible').classList.toggle('hidden')"><h4 class="text-rpg-magic font-bold text-sm flex items-center gap-2 font-header"><span class="material-symbols-outlined text-base">expand_more</span> ${title}</h4><div class="flex items-center gap-3">${level > 0 ? `<div class="flex gap-1">${generateCheckboxes(slots)}</div>` : ''}<button class="text-xs bg-rpg-magic/20 text-rpg-magic px-2 py-1 rounded hover:bg-rpg-magic hover:text-black transition-colors font-header" onclick="event.stopPropagation(); openSpellModal(${level})">+ Adicionar</button></div></div><div class="collapsible p-3 grid grid-cols-1 md:grid-cols-2 gap-3" id="spells-lvl-${level}"></div></div>`; }
    function generateCheckboxes(n) { return Array(parseInt(n)||0).fill('<input type="checkbox" class="spell-slot-check">').join(''); }
    function updateSpellSlotCheckboxes(input) { input.previousElementSibling.innerHTML = generateCheckboxes(input.value); }
    function moveSpellCard(select) { const ol=parseInt(select.closest('[id^="spells-lvl-"]').id.split('-')[2]); const nl=parseInt(select.value); if(ol===nl)return; const c=select.closest('.group'); c.querySelector('button').setAttribute('onclick', `this.closest('.group').remove(); updateSpellCount(${nl})`); document.getElementById(`spells-lvl-${nl}`).appendChild(c); updateSpellCount(ol); updateSpellCount(nl); }
    function updateSpellType(sel) { const d=damageTypes.find(x=>x.val===sel.value); const c=sel.closest('.group').querySelector('.spell-icon-container'); c.querySelector('span').textContent=d.icon; c.className=`spell-icon-container w-8 h-8 rounded bg-black flex-shrink-0 flex items-center justify-center border border-gray-600 transition-colors ${d.color}`; }
    function updateSpellCount(l) {}

    function openSpellModal(level) { document.getElementById('modal-spell-level').value = level; const sel = document.getElementById('spell-library-select'); sel.innerHTML = '<option value="">-- Selecione --</option>'; SRD_LIB.spells.filter(s => s.level === level).forEach(s => { const opt = document.createElement('option'); opt.value = JSON.stringify(s); opt.text = s.name; sel.appendChild(opt); }); document.getElementById('spell-selector-modal').classList.add('open'); }
    function closeSpellModal() { document.getElementById('spell-selector-modal').classList.remove('open'); }
    function addCustomSpell() { createSpellCardElement(document.getElementById('modal-spell-level').value, "Nova Magia", "", "", "fire", "", "", "", "", ""); closeSpellModal(); }
    function addSelectedSpellFromLib() { const s = JSON.parse(document.getElementById('spell-library-select').value || "{}"); if(s.name) createSpellCardElement(document.getElementById('modal-spell-level').value, s.name, s.desc, "", s.type, "", "", "", "", ""); closeSpellModal(); }
    function createSpellCardElement(level, name, desc, dmg, typeVal, higher, time, range, comps, dur) { const div = document.createElement('div'); div.className = "bg-[#181818] border border-gray-700 rounded-lg p-3 relative group hover:border-rpg-magic/50 transition-colors"; const typeObj = damageTypes.find(d => d.val === typeVal) || damageTypes[0]; div.innerHTML = `<div class="flex items-center justify-between mb-2"><div class="flex items-center gap-2"><div class="w-6 h-6 rounded bg-black flex items-center justify-center border border-gray-600 ${typeObj.color}"><span class="material-symbols-outlined text-sm">${typeObj.icon}</span></div><input class="bg-transparent font-bold text-white text-sm outline-none w-32 font-header" value="${name}" placeholder="Nome"></div><div class="flex items-center gap-2"><div class="combat-toggle" onclick="toggleSpellInCombat(this)" title="Armar em Combate"></div><button onclick="this.closest('.group').remove(); updateSpellCount(${level})" class="text-gray-600 hover:text-red-500 text-xs font-bold">√ó</button></div></div><div class="grid grid-cols-4 gap-1 text-[8px] uppercase text-gray-500 mb-2"><input class="bg-transparent text-center border-b border-gray-800" placeholder="TMP" value="${time||''}"><input class="bg-transparent text-center border-b border-gray-800" placeholder="ALC" value="${range||''}"><input class="bg-transparent text-center border-b border-gray-800" placeholder="CMP" value="${comps||''}"><input class="bg-transparent text-center border-b border-gray-800" placeholder="DUR" value="${dur||''}"></div><div class="flex gap-2 mb-2"><select class="bg-black/30 text-[10px] text-gray-400 rounded border border-gray-800 w-1/2 font-body">${damageTypes.map(d=>`<option value="${d.val}" ${d.val===typeVal?'selected':''}>${d.label}</option>`).join('')}</select><input class="bg-black/30 text-center text-[10px] text-white rounded border border-gray-800 w-1/2" placeholder="Dano (ex: 1d8)" value="${dmg||''}"></div><textarea class="w-full bg-black/20 text-[10px] text-gray-400 p-2 rounded resize-none h-10 outline-none border-none custom-scrollbar font-body" placeholder="Descri√ß√£o...">${desc}</textarea>`; document.getElementById(`spells-lvl-${level}`).appendChild(div); }
    
    function toggleSpellInCombat(btn) { btn.classList.toggle('active'); renderCombatSpells(); }
    function renderCombatSpells() {
        const tbody = document.getElementById('spell-combat-rows'); tbody.innerHTML = '';
        document.querySelectorAll('.combat-toggle.active').forEach(toggle => {
            const card = toggle.closest('.group'); const name = card.querySelector('input[placeholder="Nome"]').value; const dmg = card.querySelector('input[placeholder="Dano (ex: 1d8)"]').value; const type = card.querySelector('select').value;
            const tr = document.createElement('tr'); tr.className = "bg-rpg-magic/10 border-b border-gray-800/50 font-body";
            tr.innerHTML = `<td class="p-3 pl-4 text-rpg-magic"><span class="material-symbols-outlined text-sm">auto_stories</span></td><td class="p-3 text-center text-rpg-magic"></td><td class="p-3 text-center"><span class="material-symbols-outlined text-xs text-rpg-magic">check</span></td><td class="p-3 font-bold text-white">${name}</td><td class="p-3 text-xs uppercase text-gray-500">INT</td><td class="p-3 text-center text-gray-500">-</td><td class="p-3 text-center font-bold text-rpg-magic text-lg">CD 15</td><td class="p-3 text-gray-400">${dmg || '-'}</td><td class="p-3 text-white font-bold">${dmg || 'Efeito'}</td><td class="p-3 text-xs text-gray-400 capitalize">${type}</td><td class="p-3"></td>`;
            tbody.appendChild(tr);
        });
    }

    function addInventoryRow() { const id = 'inv-' + Date.now(); const tr = document.createElement('tr'); tr.className = "border-b border-gray-800/50 hover:bg-white/5 transition-colors font-body"; tr.setAttribute('data-row-id', id); tr.innerHTML = `<td class="py-2 pl-3"><button class="text-gray-600 hover:text-white"><span class="material-symbols-outlined text-sm">backpack</span></button></td><td class="py-2 pl-2"><input class="w-full text-white text-sm font-body" placeholder="Item Name"></td><td class="py-2 text-center"><input type="number" class="w-full text-center text-gray-400 text-sm qty-input" placeholder="1" oninput="calculateWeight()"></td><td class="py-2 text-right pr-3"><input type="number" class="w-full text-right text-gray-400 text-sm weight-input" placeholder="0" oninput="calculateWeight()"></td><td class="py-2 text-center"><button onclick="openItemEditor(this)" class="text-gray-600 hover:text-white"><span class="material-symbols-outlined text-sm">edit</span></button></td>`; document.getElementById('inventory-rows').appendChild(tr); }
    function openItemEditor(element) {
        const isSlot = element.classList.contains('equip-input'); const context = isSlot ? 'slot' : 'inventory'; let id, currentData;
        if (isSlot) { id = element.dataset.slot; currentData = equipmentData[id] || { name: "", desc: "", weight: 0, ac: 0, atk: 0, dmg: 0, dc: 0 }; } 
        else { const row = element.closest('tr'); id = row.getAttribute('data-row-id'); const nameInput = row.querySelector('input[placeholder="Item Name"]'); const weightInput = row.querySelector('.weight-input'); currentData = { name: nameInput.value, weight: weightInput.value, desc: "" }; }
        document.getElementById('modal-target-id').value = id; document.getElementById('modal-context-type').value = context; document.getElementById('modal-item-name').value = currentData.name || (isSlot ? element.value : ""); document.getElementById('modal-item-weight').value = currentData.weight || ""; 
        document.getElementById('modal-item-desc').value = currentData.desc || ""; 
        
        document.getElementById('modal-bonus-ac').value = currentData.ac || 0;
        document.getElementById('modal-bonus-atk').value = currentData.atk || 0;
        document.getElementById('modal-bonus-dmg').value = currentData.dmg || 0;
        document.getElementById('modal-bonus-dc').value = currentData.dc || 0;

        document.getElementById('item-editor-modal').classList.add('open');
    }
    function closeItemEditor() { document.getElementById('item-editor-modal').classList.remove('open'); }
    
    // --- FUN√á√ÉO DE SALVAR CORRIGIDA ---
    function saveItemEditor() {
        const id = document.getElementById('modal-target-id').value; const type = document.getElementById('modal-context-type').value; const name = document.getElementById('modal-item-name').value;
        const weight = document.getElementById('modal-item-weight').value;
        const desc = document.getElementById('modal-item-desc').value;
        const ac = parseInt(document.getElementById('modal-bonus-ac').value) || 0;
        const atk = parseInt(document.getElementById('modal-bonus-atk').value) || 0;
        const dmg = parseInt(document.getElementById('modal-bonus-dmg').value) || 0;
        const dc = parseInt(document.getElementById('modal-bonus-dc').value) || 0;

        if (type === 'slot') { 
            equipmentData[id] = { name, weight, desc, ac, atk, dmg, dc }; 
            const input = document.querySelector(`.equip-input[data-slot="${id}"]`); 
            input.value = name; 
            input.setAttribute('data-desc', desc);
            if(ac || atk || dmg || dc) input.classList.add('has-stats'); else input.classList.remove('has-stats');
        } else {
            const row = document.querySelector(`tr[data-row-id="${id}"]`); if(row) { 
                row.querySelector('input[placeholder="Item Name"]').value = name; 
                row.querySelector('.weight-input').value = weight; 
            }
        }
        closeItemEditor(); calculateWeight(); calculateAll(); updateInventoryFromEquipment();
    }
    
    function importItemFromLib(select) { 
        const idx = select.value; 
        if(idx === "") return; 
        const item = SRD_LIB.items[idx]; 
        document.getElementById('modal-item-name').value = item.name; 
        document.getElementById('modal-item-desc').value = item.desc || ""; 
        document.getElementById('modal-item-weight').value = item.weight; 
        document.getElementById('modal-bonus-ac').value = item.ac || 0;
        document.getElementById('modal-bonus-atk').value = item.atk || 0;
        document.getElementById('modal-bonus-dmg').value = item.dmg || 0;
        document.getElementById('modal-bonus-dc').value = item.dc || 0;
    }
    function calculateWeight() { let t = 0; document.querySelectorAll('#inventory-rows tr').forEach(r => { t += (parseFloat(r.querySelector('.qty-input').value)||0) * (parseFloat(r.querySelector('.weight-input').value)||0); }); const d = document.getElementById('weight-display'); const max = 75; d.innerHTML = `${t.toFixed(1)} / <span id="max-weight">${max}</span> kg`; }
    
    function calculateAll() { 
        const pb = Math.ceil((parseInt(document.getElementById('char-level').value)||1)/4)+1; document.getElementById('prof-bonus').textContent = `+${pb}`;
        const mods={}; 
        attributes.forEach(a=>{ 
            const s=parseInt(document.getElementById(`score-${a.id}`).value)||10; 
            const m=Math.floor((s-10)/2); 
            mods[a.id]=m; 
            document.getElementById(`mod-${a.id}`).textContent=m>=0?`+${m}`:m; 
            let sv=m; 
            if(document.getElementById(`save-${a.id}`).checked)sv+=pb; 
            document.getElementById(`save-val-${a.id}`).textContent=sv>=0?`+${sv}`:sv; 
        });

        // Recalcular pericias
        skills.forEach((s,i)=>{ 
            const cb=document.getElementById(`skill-${i}`); 
            let v=mods[s.attr]; 
            if(cb && cb.checked) v+=pb; 
            const el=document.getElementById(`skill-val-${i}`); 
            if(el) el.textContent=v>=0?`+${v}`:v; 
        });

        const eb = getGlobalEquipmentBonuses();
        const dexMod = mods['dex'] || 0; 
        const manualAC = parseInt(document.getElementById('ac-bonus-manual').value) || 0;
        document.getElementById('ac-total-display').textContent = 10 + dexMod + manualAC + eb.ac;
        
        const acDisp = document.getElementById('ac-equip-bonus-display');
        if (eb.ac !== 0) {
            acDisp.textContent = `+ ${eb.ac} (Equip)`;
            acDisp.classList.remove('hidden');
        } else {
            acDisp.classList.add('hidden');
        }
        document.getElementById('initiative-display').textContent = dexMod>=0?`+${dexMod}`:dexMod;
    }
    
    function toggleAttune(el) { el.classList.toggle('active'); updateAttunement(); }
    function updateAttunement() { 
        const c = document.querySelectorAll('.attunement-indicator.active').length; 
        const display = document.getElementById('attunement-display'); 
        if(display) display.textContent = `(${c}/3 Sintonizados)`;
        updateInventoryFromEquipment();
    }
    function loadPortrait(e) { if(e.target.files[0]) { const reader = new FileReader(); reader.onload = function(evt) { document.getElementById('char-portrait').src = evt.target.result; }; reader.readAsDataURL(e.target.files[0]); } }
    function downloadSheet() { const blob = new Blob([document.documentElement.outerHTML], {type: 'text/html'}); const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = `Ficha_RPG.html`; a.click(); }
    
    // --- ADD COMBAT ROW ---
    function addCombatRow(n=1) {
        const b = document.getElementById('combat-rows');
        for(let i=0;i<n;i++) {
            const tr = document.createElement('tr'); 
            tr.className = "combat-row border-b border-gray-800 hover:bg-white/5 transition-colors group font-body";
            tr.innerHTML = `
                <td class="p-3 w-8 text-center"><button onclick="toggleDetails(this)" class="text-gray-500 hover:text-white transition-transform duration-300"><span class="material-symbols-outlined text-sm rotate-chevron">expand_more</span></button></td>
                <td class="p-3 text-center"><button onclick="cycleCombatIconBtn(this)" class="text-gray-400 hover:text-white transition-colors"><span class="material-symbols-outlined text-lg">swords</span></button></td>
                <td class="p-3 text-center"><input type="checkbox" class="accent-rpg-combat w-4 h-4 cursor-pointer prof-check" onchange="calculateAll()"></td>
                <td class="p-3"><input class="bg-transparent w-full font-bold text-white outline-none placeholder-gray-600" placeholder="Arma"></td>
                <td class="p-3"><select class="bg-black/40 text-gray-300 text-xs rounded p-1 outline-none border border-gray-700 attr-select w-full" onchange="calculateAll()"><option value="str">FOR</option><option value="dex">DES</option><option value="con">CON</option><option value="int">INT</option><option value="wis">SAB</option><option value="cha">CAR</option></select></td>
                <td class="p-3 text-center"><input type="number" class="magic-bonus-input bg-transparent w-full text-center text-rpg-magic font-bold outline-none placeholder-gray-800" placeholder="+0" oninput="calculateAll()"></td>
                <td class="p-3 text-center bg-rpg-accent/5 rounded"><span class="font-bold text-lg text-rpg-accent attack-bonus">+0</span></td>
                <td class="p-3"><input class="base-dmg-input bg-transparent w-full text-white outline-none placeholder-gray-600 text-center" placeholder="1d8" oninput="calculateAll()"></td>
                <td class="p-3 text-left bg-rpg-combat/5 rounded"><span class="font-bold text-lg text-rpg-combat damage-total-display">--</span></td>
                <td class="p-3"><input class="base-type-input bg-transparent w-full text-gray-400 outline-none placeholder-gray-600 text-xs" placeholder="Tipo"></td>
                <td class="p-3 text-center"><button onclick="removeCombatRow(this)" class="text-gray-600 hover:text-rpg-red opacity-0 group-hover:opacity-100">√ó</button></td>`;
            b.appendChild(tr);

            const trD = document.createElement('tr'); 
            trD.className = "bg-black/20 hidden"; 
            trD.innerHTML = `
                <td colspan="11" class="p-0">
                    <div class="collapsible-content">
                        <div class="p-3 pl-12 border-b border-gray-800">
                            <div class="flex justify-between items-start mb-2"><h4 class="text-[10px] uppercase text-gray-500 font-bold font-header">Danos Adicionais</h4></div>
                            <div class="extra-damage-container grid gap-2"></div>
                            <button class="mt-3 text-[10px] text-rpg-accent hover:text-white border border-dashed border-rpg-accent/30 hover:border-rpg-accent px-2 py-1 rounded transition-colors font-header" onclick="addExtraDamageRow(this)">+ Add Dano Extra</button>
                        </div>
                    </div>
                </td>`;
            b.appendChild(trD);
        }
    }

    function toggleDetails(btn) { 
        const d = btn.closest('tr').nextElementSibling; 
        d.classList.toggle('hidden'); 
        setTimeout(()=>{d.querySelector('.collapsible-content').classList.toggle('open'); btn.querySelector('.rotate-chevron').classList.toggle('open')},10); 
    }

    function removeCombatRow(btn) { 
        const tr=btn.closest('tr'); 
        tr.nextElementSibling.remove(); 
        tr.remove(); 
    }

    function addExtraDamageRow(btn) { 
        const d = document.createElement('div'); 
        d.className = "flex items-center gap-2 animate-up extra-dmg-row"; 
        d.innerHTML = `<input class="extra-dice bg-black/30 text-white text-xs p-1 rounded w-16 text-center border border-gray-700 focus:border-rpg-combat outline-none font-body" placeholder="1d6" oninput="updateCombatRow(this.closest('tr').previousElementSibling)"><input class="bg-transparent text-gray-500 text-xs w-full outline-none border-b border-gray-800 font-body" placeholder="Tipo/Notas"><button onclick="removeExtraRow(this)" class="text-gray-600 hover:text-red-500 text-xs">√ó</button>`; 
        btn.previousElementSibling.appendChild(d); 
    }

    function removeExtraRow(btn) { 
        const tr=btn.closest('tr').previousElementSibling; 
        btn.parentElement.remove(); 
        updateCombatRow(tr); 
    }
    
    // --- FUN√á√ÉO DE ATUALIZA√á√ÉO DO INVENT√ÅRIO ---
    function updateInventoryFromEquipment() {
        const tbody = document.getElementById('inventory-equipped-rows'); 
        tbody.innerHTML = ''; 
        for (const [id, data] of Object.entries(equipmentData)) {
            if (!data.name) continue;
            // Verifica sintoniza√ß√£o
            const slotEl = document.querySelector(`.equip-input[data-slot="${id}"]`);
            const isAttuned = slotEl && slotEl.parentElement.querySelector('.attunement-indicator.active');
            
            const tr = document.createElement('tr');
            tr.className = "bg-rpg-accent/5 border-b border-rpg-accent/10 font-body";
            
            let badges = '<span class="tag-badge tag-equipped">EQUIPADO</span>';
            if(isAttuned) badges += '<span class="tag-badge tag-attuned">SINTONIZADO</span>';

            tr.innerHTML = `<td class="py-2 pl-3 text-rpg-accent"><span class="material-symbols-outlined text-sm">checkroom</span></td><td class="py-2 pl-2"><div class="flex flex-col"><span class="text-rpg-accent font-bold text-sm">${data.name}</span><div class="flex gap-1 mt-0.5">${badges}</div></div></td><td class="py-2 text-center text-gray-500 text-xs">1</td><td class="py-2 text-right pr-3 text-gray-400 text-xs">${data.weight||0}</td><td class="py-2 text-center"><button onclick="openItemEditor(document.querySelector('.equip-input[data-slot=${id}]'))" class="text-rpg-accent hover:text-white"><span class="material-symbols-outlined text-sm">edit</span></button></td>`;
            tbody.appendChild(tr);
        }
    }

    // 3. INICIALIZA√á√ÉO
    document.addEventListener('DOMContentLoaded', () => {
        populateSelects(); populateItemLib(); renderAttributes(); renderSkills(); renderInventory(5); addCombatRow(1); initSpellbook(); 
        document.querySelectorAll('.equip-input').forEach(input => { const slot = input.dataset.slot; if(input.value && !equipmentData[slot]) equipmentData[slot] = { name: input.value, weight: 0 }; });
        calculateAll(); // Initial calculation
    });
</script>
</body>
</html>